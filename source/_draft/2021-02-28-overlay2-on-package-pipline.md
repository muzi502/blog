---
title: registry + overlay2 åœ¨å®¹å™¨äº‘å¹³å°å‘æ‰“åŒ…å‘å¸ƒä¸­çš„åº”ç”¨
date: 2021-02-10
updated: 2021-02-11
slug:
categories: æŠ€æœ¯
tag:
  - registry
  - images
  - OCI
copyright: true
comment: true
---

## èƒŒæ™¯

è‡ªä»å»å¹´äº”æœˆä»½å…¥èŒåä¸€ç›´åœ¨è´Ÿè´£å…¬å¸ toB äº§å“ï¼šCompass å®¹å™¨äº‘å¹³å°å’Œ Clever äººå·¥æ™ºèƒ½äº‘å¹³å°çš„å‘å¸ƒåŠéƒ¨ç½²å·¥ä½œã€‚æ€§è´¨ä¸Šæœ‰ç‚¹ç±»ä¼¼äº Kubernetes SIGs ç¤¾åŒºçš„ Release å›¢é˜Ÿã€‚ä½¿ç”¨æœŸæœŸé—´çš„ä¸»è¦å·¥ä½œå°±æ˜¯ä¼˜åŒ–æˆ‘ä»¬å…ˆæœ‰çš„æ‰“åŒ…å‘å¸ƒæµç¨‹ã€‚åœ¨è¿™æœŸé—´å¯¹æ‰“åŒ…å‘å¸ƒæµæ°´çº¿ä¼˜åŒ–äº†å¾ˆå¤šï¼Œå…¶ä¸­æœ€çªå‡ºçš„æ˜¯é•œåƒåŒæ­¥çš„ä¼˜åŒ–ï¼Œå°†é•œåƒåŒæ­¥çš„é€Ÿåº¦æå‡äº† 5 åˆ° 15 å€ã€‚å¤§å¤§ç¼©çŸ­äº†æ•´ä¸ªäº§å“çš„å‘å¸ƒè€—æ—¶ï¼Œä¹Ÿå¾—åˆ°äº†åŒäº‹ä»¬çš„ä¸€è‡´å¥½è¯„ã€‚äºæ˜¯ä»Šå¤©å°±æƒ³ç€æŠŠè¿™é¡¹ä¼˜åŒ–å’ŒèƒŒåçš„åŸç†åˆ†äº«å‡ºæ¥ã€‚å› ä¸ºè¿™äº›ä»£ç æ˜¯å¼€æºçš„ï¼Œæ‰€ä»¥ä¹Ÿä¸å¿…æ‹…å¿ƒæ³„éœ²å…¬å¸æœºå¯†ä»€ä¹ˆçš„ã€‚

æˆ‘ä»¬çš„äº§å“æ‰“åŒ…æ—¶ä¼šæœ‰ä¸€ä¸ªé•œåƒåˆ—è¡¨ï¼Œå¹¶æ ¹æ®è¿™ä¸ªé•œåƒåˆ—è¡¨åœ¨ CI/CD çš„æµæ°´çº¿é•œåƒä»“åº“é‡Œå°†é•œåƒåŒæ­¥åˆ°ä¸€ä¸ªå‘å¸ƒå½’æ¡£çš„é•œåƒä»“åº“å’Œä¸€ä¸ªæ‰“åŒ…çš„é•œåƒä»“åº“ã€‚æœ€ç»ˆä¼šå°†æ‰“åŒ…çš„é•œåƒä»“åº“çš„ registry å­˜å‚¨ç›®å½•æ‰“åŒ…ä¸€ä¸ªæœªç» gzip å‹ç¼©çš„ tar åŒ…ã€‚æœ€ç»ˆåœ¨å®¢æˆ·ç¯å¢ƒéƒ¨ç½²çš„æ—¶å€™å°†è¿™ä¸ª tar åŒ…è§£å‹åˆ°éƒ¨ç½²çš„é•œåƒä»“åº“å­˜å‚¨ç›®å½•ä¸­ï¼Œä¾›é›†ç¾¤éƒ¨ç½²å’Œç»„ä»¶éƒ¨ç½²ä½¿ç”¨ã€‚è‡³äºéƒ¨ç½²çš„æ—¶å€™ä¸ºä»€ä¹ˆå¯ä»¥è¿™æ ·åšï¼Œå…¶ä¸­çš„åŸç†å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰å†™è¿‡çš„æ–‡ç«  [docker registry è¿ç§»è‡³ harbor](https://blog.k8s.li/docker-registry-to-harbor.html)ã€‚

åœ¨æ‰“åŒ…çš„è¿‡ç¨‹ä¸­é•œåƒåŒæ­¥ä¼šè¿›è¡Œä¸¤æ¬¡ï¼Œæ¯æ¬¡éƒ½ä¼šæ ¹æ®ä¸€ä¸ª images.list åˆ—è¡¨å°†é•œåƒåŒæ­¥åˆ°ä¸åŒçš„é•œåƒä»“åº“ä¸­ï¼ŒåŒæ­¥çš„æ–¹å¼ä½¿ç”¨çš„æ˜¯  `docker pull â€“> docker tag â€“> docker push`ã€‚ç¬¬ä¸€æ¬¡æ˜¯ä»CI/CD æµæ°´çº¿é•œåƒä»“åº“ï¼ˆcicd.registry.localï¼‰ä¸­æ‹‰å–é•œåƒå¹¶ push åˆ°å‘å¸ƒå½’æ¡£çš„é•œåƒä»“åº“(archive.registry.local)ä¸­ï¼Œå…¶ç›®çš„æ˜¯å½’æ¡£å¹¶å¤‡ä»½æˆ‘ä»¬å·²ç»å‘å¸ƒçš„é•œåƒã€‚

ç¬¬äºŒæ¬¡å°†é•œåƒä»å‘å¸ƒå½’æ¡£çš„é•œåƒä»“åº“ (archive.registry.local) åŒæ­¥é•œåƒåˆ°æ‰“åŒ…é•œåƒä»“åº“ï¼ˆpackage.registry.localï¼‰ä¸­ã€‚ä¸åŒäºç¬¬ä¸€æ¬¡çš„é•œåƒåŒæ­¥ï¼Œè¿™æ¬¡åŒæ­¥é•œåƒçš„æ—¶å€™ä¼šå¯¹é•œåƒä»“åº“åšæ¸…ç†çš„æ“ä½œï¼Œé¦–å…ˆæ¸…ç†æ‰“åŒ…é•œåƒä»“åº“çš„å­˜å‚¨ç›®å½•ï¼Œç„¶åå®¹å™¨ registry å®¹å™¨è®© registry é‡æ–°æå–é•œåƒçš„å…ƒæ•°æ®ä¿¡æ¯åˆ°å†…å­˜ä¸­ã€‚å…¶ç›®çš„æ˜¯æ¸…ç†æ—§æ•°æ®ï¼Œé˜²æ­¢å†å²çš„é•œåƒå¸¦å…¥æœ¬æ¬¡å‘å¸ƒç‰ˆæœ¬çš„å®‰è£…åŒ…ä¸­ã€‚é•œåƒåŒæ­¥å®Œæˆä¹‹åä¼šå°†æ•´ä¸ªæ‰“åŒ…é•œåƒä»“åº“çš„å­˜å‚¨ç›®å½•æ‰“åŒ…æˆä¸€ä¸ª tar åŒ…ï¼Œå¹¶æ”¾åˆ°äº§å“å®‰è£…åŒ…ä¸­ã€‚

## é—®é¢˜

æˆ‘åˆšå…¥èŒçš„æ—¶å€™ï¼Œæˆ‘ä»¬çš„äº§å“å‘å¸ƒè€—æ—¶æœ€ä¹…çš„å°±æ˜¯é•œåƒåŒæ­¥é˜¶æ®µï¼Œ æœ€é•¿çš„æ—¶å€™è€—æ—¶ `2h30min`ã€‚è€—æ—¶è¿™ä¹ˆä¹…çš„ä¸»è¦åŸå› å¦‚ä¸‹ï¼š

### docker æ€§èƒ½é—®é¢˜

å› ä¸ºåœ¨åšé•œåƒåŒæ­¥çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯  `docker pull â€“> docker tag â€“> docker push` çš„æ–¹å¼ã€‚è€Œåœ¨ docker pull å’Œ docker push çš„è¿‡ç¨‹ä¸­ docker å®ˆæŠ¤è¿›ç¨‹éƒ½ä¼šå¯¹é•œåƒçš„ layer åšè§£å‹ç¼©çš„æ“ä½œã€‚è¿™æ˜¯åŠå…¶è€—æ—¶å’Œæµªè´¹ CPU èµ„æºçš„ã€‚åˆå› ä¸ºæˆ‘ä»¬çš„å†…ç½‘æœºå™¨æ€§èƒ½ååˆ†åœ°çƒ‚ï¼Œæœ‰æ—¶ç”šè‡³è¿ USB 2.0 çš„é€Ÿåº¦éƒ½ä¸å¦‚ï¼é‚£æ…¢çš„ç¨‹åº¦å¯æƒ³è€ŒçŸ¥ã€‚

### æ— æ³•å¤ç”¨æ—§æ•°æ®

åœ¨ç¬¬äºŒæ¬¡é•œåƒåŒæ­¥æ—¶ä¼šå¯¹æ‰“åŒ…é•œåƒä»“åº“åšæ¸…ç†çš„æ“ä½œï¼Œå¯¼è‡´æ— æ³•å¤ç”¨å†å²çš„é•œåƒã€‚å…¶å®æ¯æ¬¡å‘å¸ƒçš„æ—¶å€™ï¼Œå˜æ›´å’Œæ–°å¢çš„é•œåƒå¾ˆå°‘ï¼Œå¹³å‡ä¸ºåŸæ¥çš„ 1/10 å·¦å³ï¼Œå¢é‡åŒæ­¥çš„é•œåƒä¹Ÿå°±é‚£ä¹ˆä¸€ä¸¢ä¸¢è€Œå·²ã€‚å› ä¸ºè¦ä¿è¯è¿™æ¬¡æ‰“åŒ…å‘å¸ƒçš„é•œåƒä»“åº“ä¸­åªèƒ½åŒ…å¥½è¿™ä¸ªéœ€è¦çš„é•œåƒï¼Œä¸èƒ½åŒ…å«ä¸æœ¬æ¬¡æ— å…³çš„é•œåƒï¼Œå› æ­¤æ¯æ¬¡éƒ½éœ€è¦æ¸…ç†æ‰“åŒ…é•œåƒä»“åº“ï¼Œè¿™æ— æ³•é¿å…ã€‚

## ä¼˜åŒ–

æ ¹æ®ä¸Šé¢æåˆ°çš„ä¸¤ä¸ªé—®é¢˜ï¼Œç»è¿‡åå¤çš„ç ”ç©¶å’Œæµ‹è¯•ç»ˆäºéƒ½å®Œç¾åœ°è§£å†³äº†ã€‚

### skopeo æ›¿ä»£ docker

é’ˆå¯¹  `docker pull â€“> docker tag â€“> docker push`  çš„æ€§èƒ½é—®é¢˜ï¼Œå½“æ—¶ç¬¬ä¸€ä¸ªæ–¹æ¡ˆæƒ³åˆ°çš„å°±æ˜¯ä½¿ç”¨ skopeo æ¥æ›¿ä»£å®ƒã€‚ä½¿ç”¨ `skopeo copy` ç›´æ¥å°†é•œåƒä»ä¸€ä¸ª registry å¤åˆ¶åˆ°å¦ä¸€ä¸ª registry ä¸­ã€‚å…³äº skopeo çš„ä½¿ç”¨å’Œå…¶èƒŒåçš„åŸç†å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„åšå®¢ [é•œåƒæ¬è¿å·¥ skopeo åˆä½“éªŒ](https://blog.k8s.li/skopeo.html) ã€‚ä½¿ç”¨ skopeo ä¹‹åé•œåƒåŒæ­¥æ¯”ä¹‹å‰å¿«äº†å¾ˆå¤šï¼Œå¹³å‡å¿«äº† 5 å€å·¦å³ã€‚

###  overlay2 å¤ç”¨æ—§æ•°æ®

è§£å†³äº† docker çš„æ€§èƒ½é—®é¢˜ï¼Œå‰©ä¸‹çš„å°±æ˜¯æ— æ³•å¤ç”¨æ—§æ•°æ®çš„é—®é¢˜äº†ã€‚åœ¨å¦‚ä½•ä¿ç•™å†å²é•œåƒçš„é—®é¢˜ä¸Šå¯ç…è´¹è‹¦å¿ƒã€‚å½“æ—¶ä¹Ÿä¸çŸ¥é“å°±æƒ³åˆ°äº† overlay2 çš„ç‰¹æ€§ï¼š`å†™æ—¶å¤åˆ¶`ã€‚å°±å¥½æ¯”å¦‚ docker run å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œåœ¨å®¹å™¨å†…è¿›è¡Œä¿®æ”¹å’Œåˆ é™¤æ–‡ä»¶çš„æ“ä½œï¼Œè¿™äº›æ“ä½œå¹¶ä¸ä¼šå½±å“åˆ°é•œåƒæœ¬èº«ï¼Œå› ä¸º docker ä½¿ç”¨ overlay2 è”åˆæŒ‚è½½çš„æ–¹å¼å°†é•œåƒçš„æ¯ä¸€å±‚æŒ‚è½½ä¸ºä¸€ä¸ª merged çš„å±‚ã€‚åœ¨å®¹å™¨å†…çœ‹åˆ°çš„å°±æ˜¯è¿™ä¸ª merged çš„å±‚ï¼Œåœ¨å®¹å™¨å†…å¯¹ merged å±‚æ–‡ä»¶çš„ä¿®æ”¹å’Œåˆ é™¤æ“ä½œæ˜¯é€šè¿‡ overlay2 çš„ upper å±‚å®Œæˆçš„ï¼Œå¹¶ä¸ä¼šå½±å“åˆ°é•œåƒæœ¬èº«ã€‚

ä» docker å®˜æ–¹æ–‡æ¡£ [Use the OverlayFS storage driver](https://docs.docker.com/storage/storagedriver/overlayfs-driver/) é‡Œå·æ¥çš„ä¸€å¼ å›¾ç‰‡

![img](img/overlay_constructs.jpg)

å…³äºä¸Šå›¾ä¸­è¿™äº› Dir çš„ä½œç”¨ï¼Œä¸‹é¢æ˜¯ä¸€æ®µä» [StackOverflow](https://stackoverflow.com/questions/56550890/docker-image-merged-diff-work-lowerdir-components-of-graphdriver) ä¸Šæ¬è¿è¿‡æ¥çš„è§£é‡Šã€‚

>   **LowerDir**: these are the read-only layers of an overlay filesystem. For docker, these are the image layers assembled in order.
>
>   **UpperDir**: this is the read-write layer of an overlay filesystem. For docker, that is the equivalent of the container specific layer that contains changes made by that container.
>
>   **WorkDir**: this is a required directory for overlay, it needs an empty directory for internal use.
>
>   **MergedDir**: this is the result of the overlay filesystem. Docker effectively chrootâ€™s into this directory when running the container.

å¦‚æœæƒ³å¯¹ overlayfs æ–‡ä»¶ç³»ç»Ÿæœ‰è¯¦ç»†çš„äº†è§£ï¼Œå¯ä»¥å‚è€ƒ Linux å†…æ ¸å®˜ç½‘ä¸Šçš„è¿™ç¯‡æ–‡æ¡£ [overlayfs.txt](https://www.kernel.org/doc/Documentation/filesystems/overlayfs.txt) ã€‚

æ€»ä¹‹ overlay2 å¤§æ³•å¥½ï¼æ—¢ç„¶æ‰¾åˆ°äº†æ–¹æ³•ï¼Œå°±çœ‹çœ‹æ€ä¹ˆå®ç°äº†ã€‚

## overlay2

### registry å­˜å‚¨ç»“æ„

å†ä¸€æ¬¡æ¬å‡ºè¿™å¼  registry å­˜å‚¨ç›®å½•ç»“æ„çš„å›¾ç‰‡ğŸ˜‚

![](https://p.k8s.li/registry-storage.jpeg)

z

### å¥—å¨ƒï¼šé•œåƒé‡Œå¡é•œåƒï¼Ÿ

ç¬¬ä¸€ä¸ªæƒ³åˆ°çš„æ–¹æ¡ˆå°±æ˜¯å°†å†å²çš„é•œåƒä»“åº“å­˜å‚¨ç›®å½•å¤åˆ¶åˆ°ä¸€ä¸ª registry çš„é•œåƒé‡Œï¼Œç„¶åç”¨è¿™ä¸ªé•œåƒæ¥å¯åŠ¨æ‰“åŒ…é•œåƒä»“åº“çš„ registry å®¹å™¨ã€‚

-   Dockerfile

```dockerfile
FROM registry:latest

ADD docker.tar /var/lib/registry/
RUN find /var/lib/registry/docker/registry/v2/repositories -type d -name "_manifests" -exec rm -rf {} \;
```

### å®¹å™¨æŒ‚è½½ merged ç›®å½•



## ç»“æœ

