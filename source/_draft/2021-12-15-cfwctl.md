---
title: Tencent Cloud lighthouse Firewall tool
date: 2021-12-15
updated: 2021-12-15
slug:
categories: æŠ€æœ¯
tag:
  - äº‘æœåŠ¡å™¨
copyright: true
comment: true
---

ä¸Šæ¬¡å»åŒ—äº¬å‡ºå·®ï¼Œä¸ºäº†ä¾¿æ·åœ°è®¿é—®å®¶é‡Œå†…ç½‘ä¸­çš„ä¸€äº›æœåŠ¡ï¼Œå°±åœ¨è…¾è®¯äº‘æœåŠ¡å™¨ä¸Šéƒ¨ç½²äº†ä¸€ä¸ª frps æœåŠ¡ï¼Œåœ¨æœ¬åœ°å†…ç½‘çš„ Openwrt è·¯ç”±å™¨ä¸Šå®‰è£… frpc å®¢æˆ·ç«¯ï¼Œå°†å†…ç½‘ä¸­çš„ä¸€å° Windows æœåŠ¡å™¨ç©¿é€åˆ°è…¾è®¯äº‘æœåŠ¡å™¨ä¸Šã€‚ç„¶åé€šè¿‡ Windows RDP è¿œç¨‹è¿æ¥åˆ°è¿™å° Windows æœºå™¨ä¸Šï¼Œæ¥ä½¿ç”¨å†…ç½‘çš„ä¸€äº›æœåŠ¡ã€‚ä¹‹å‰ä¹Ÿå°è¯•è¿‡ WireGuardï¼Œä½†æ˜¯ä½¿ç”¨äº†ä¸€æ®µæ—¶é—´ä½“éªŒä¸‹æ¥æ„Ÿè§‰è¿˜æ˜¯é€šè¿‡å†…ç½‘ç©¿é€çš„æ–¹å¼æ¯”è¾ƒç¨³å®šå’Œæµç•…ã€‚äºæ˜¯æœ€ç»ˆçš„æ–¹å¼è¿˜æ˜¯é€‰ç”¨ frp å†…ç½‘ç©¿é€çš„æ–¹æ¡ˆã€‚

 æœ¬ç€æ–¹ä¾¿çœäº‹å„¿çš„åŸåˆ™å°±æ”¾å¿ƒå¤§èƒ†åœ°å¼€æ”¾äº†äº‘æœåŠ¡å™¨çš„å®‰å…¨ç»„è§„åˆ™ã€‚ä¸å¹¸çš„æ˜¯ï¼Œç”±äºè¿™æ ·çš„ç–å¿½ï¼ŒæŸä¸€å¤©æˆ‘çš„ Windows è™šæ‹Ÿæœºè¢«å¼±å£ä»¤ï¼ˆadmin2020ï¼‰ç»™çˆ†ç ´äº†ã€‚å·¨å¤§çš„æŸå¤±å°±æ˜¯æŒ‚è½½åˆ° Windows è™šæ‹Ÿæœºä¸Šçš„ NAS å­˜å‚¨è¢«å‹’ç´¢ç—…æ¯’è¿›è¡Œäº†åŠ å¯†ğŸ˜‚ã€‚ä¸è¿‡å¥½åœ¨æœ€æœ€é‡è¦çš„æ•°æ®å…¨éƒ¨å­˜åˆ°äº† OneDrive ä¸Šï¼ŒNAS ä¸ŠæŸå¤±çš„éƒ½æ˜¯ä¸€äº›ä¸‹è½½çš„ç”µå½±ã€ä¹¦ç±ä»¥åŠä¸€äº› ISOã€è™šæ‹Ÿæœºæ¨¡ç‰ˆä¹‹ç±»çš„æ–‡ä»¶ã€‚ä¸€ä¸‹å­æŸå¤±äº† 8TB çš„æ•°æ®å¾ˆå¿ƒç–¼ï¼Œæ¯•ç«Ÿæ˜¯è‡ªå·±è¾›è¾›è‹¦è‹¦æœé›†çš„èµ„æºï¼Œä½†æ˜¯ä»”ç»†æƒ³ä¸€ä¸‹ï¼Œè¿™äº›èµ„æºéƒ½ä¸æ˜¯è‡ªå·±çš„ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯ä»ä¸‹è½½ä¸‹æ¥çš„ï¼Œè¿˜å¯ä»¥é€šè¿‡åŒæ ·çš„æ–¹å¼æ‰¾å›æ¥ã€‚æˆ–è®¸æ˜¯ä¹‹å‰çœ‹è¿‡ã€Šæ–­èˆç¦»ã€‹çš„ç¼˜æ•…ï¼Œä¹Ÿçœ‹çš„å¼€äº†ï¼Œéš¾å—äº†ä¸€å¤©ä¹‹åå°±å¥½è¿‡æ¥äº†ã€‚æ¯•ç«Ÿè¿™ä¸ªä¸–ç•Œä¸Šï¼Œæ²¡æœ‰æ— æ³•ä¸èƒ½å¤±å»çš„ä¸œè¥¿ï¼Œä¹Ÿæ²¡æœ‰éå¾—å¿…é¡»è¦å¾—åˆ°çš„ä¸œè¥¿ã€‚é™¤äº†å¿«ä¹æ˜¯å±äºè‡ªå·±çš„ï¼Œå…¶ä»–çš„éƒ½æœ‰å¯èƒ½éšæ—¶è¢«å¤ºèµ°ã€‚

æœ‰äº†æ­¤æ¬¡æ•™è®­ï¼Œå°±å¼€å§‹è€ƒè™‘å¯¹æ‰‹ä¸Šçš„äº‘ä¸»æœºèµ„æºè¿›è¡Œå®‰å…¨åŠ å›ºï¼Œå°†ä¸€äº›ä¸å†…ç½‘äº’é€šçš„äº‘ä¸»æœºå®‰å…¨ç»„/é˜²ç«å¢™çš„é€šç”¨å»é™¤äº†å…è®¸æ‰€æœ‰ï¼Œåªæ·»åŠ æœ¬åœ°å…¬ç½‘ IP çš„å…è®¸è§„åˆ™ã€‚ä½†æ˜¯å¯¹äºå®¶åº­å®½å¸¦ç”¨æˆ·æ¥è®²ï¼Œå…¬ç½‘ IP å¹¶ä¸æ˜¯ä¸€ä¸ªå›ºå®šçš„ IPï¼Œè€Œæ˜¯ä¼šä¸€ç›´ä¸æ–­å˜åŒ–ï¼Œæ€»ä¸èƒ½æ¯æ¬¡å˜åŒ–ä¹‹åå†ç™»å½•åˆ°äº‘ä¸»æœºæ§åˆ¶å°æ‰‹åŠ¨æ·»åŠ ä¸€ä¸‹å§ã€‚äºæ˜¯å°±æƒ³ç€æœ‰æ²¡æœ‰è‡ªåŠ¨åŒ–çš„æ–¹å¼æ¥è‡ªåŠ¨æ·»åŠ å’Œæ›´æ–°å®‰å…¨ç»„/é˜²ç«å¢™è§„åˆ™å‘¢ï¼Ÿ

## Terraform

ç¬¬ä¸€ä¸ªæƒ³åˆ°çš„æ–¹æ¡ˆä¾¿æ˜¯ terraformï¼Œä¸»æµçš„äº‘å‚å•†éƒ½æœ‰å¯¹åº”çš„ provider æ”¯æŒï¼Œè…¾è®¯äº‘åº”è¯¥ä¹Ÿæ˜¯èƒ½å¤Ÿæ”¯æŒçš„ã€‚ä¸è¿‡çœ‹äº†å®˜æ–¹çš„ [terraform-provider-tencentcloud](https://github.com/tencentcloudstack/terraform-provider-tencentcloud) repo æ–‡æ¡£ä¹‹åï¼Œå¹¶æ²¡æœ‰æ‰¾åˆ°ç»™ lighthouse ä¸»æœºé…ç½®é˜²ç«å¢™è§„åˆ™çš„æ”¯æŒï¼Œé‚æ”¾å¼ƒã€‚

## cfwctl

æ—¢ç„¶ terraform ä¸æ”¯æŒï¼Œé‚£å°±è‡ªå·±é€ è½®å­å†™ä¸€ä¸ªå§ï¼Œå°±å«å®ƒ Cloud Firewall Control Toolï¼Œç®€ç§° [cfwctl](https://github.com/muzi502/cfwctl)ã€‚è…¾è®¯äº‘å®˜æ–¹çš„ API æ–‡æ¡£è¿˜å¯ä»¥ï¼Œè¿˜èƒ½åœ¨çº¿ç”Ÿæˆä»£ç ï¼Œç”¨èµ·æ¥ä¹Ÿååˆ†æ–¹ä¾¿ã€‚è€ƒè™‘åˆ°ä¼šå°†è¯¥å·¥å…·è¿è¡Œåˆ°è¿è¡Œåˆ° arn64 çš„è·¯ç”±å™¨ä¸Šï¼Œå› æ­¤è·¨å¹³å°è¿è¡Œ cfwctl ä½¿ç”¨ golang æ¥å®ç°æ— ç–‘æ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ï¼Œæ­£å¥½ä¹Ÿèƒ½æ¥ç»ƒç»ƒæ‰‹ã€‚

æ‰§è¡Œçš„æ“ä½œå…¶å®å¾ˆç®€å•ï¼Œå…ˆæ˜¯é€šè¿‡æŸç§æ–¹å¼è·å–æœ¬åœ°æœºå™¨çš„å…¬ç½‘ IPï¼Œç„¶åå°†è¯¥ IP æ·»åŠ åˆ°å¯¹åº”å®ä¾‹çš„é˜²ç«å¢™è§„åˆ™å½“ä¸­ï¼Œå¹¶åœ¨è§„åˆ™æè¿°ä¸­æ·»åŠ æ ‡è¯†ç¬¦æ¥æ ‡è®°ã€‚ç›®å‰è‡ªå·±åªéœ€è¦æ·»åŠ è§„åˆ™ï¼Œå…ˆå‡‘æ´»ç€ç”¨ä¸€æ®µæ—¶é—´ï¼Œçœ‹ä¸‹æ•ˆæœå¦‚ä½•ã€‚ç›®å‰åªæ”¯æŒè…¾è®¯äº‘çš„ lighthouse å®ä¾‹ï¼Œåç»­æœ‰æœºä¼šå†å¢åŠ å‡ ä¸ªåˆ«çš„äº‘å‚å•†æ”¯æŒã€‚

### è·å–å…¬ç½‘ IP

é¦–å…ˆè¦è·å–åˆ°æˆ‘ä»¬æœ¬åœ°ç½‘è·¯çš„å…¬ç½‘ IPï¼Œç”±äºå…¬ç½‘ IP å¯èƒ½ä¸€ç›´æ˜¯å˜åŒ–çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¯æ¬¡æ›´æ–°é˜²ç«å¢™è§„åˆ™ä¹‹å‰éƒ½éœ€è¦è·å–æœ€æ–°çš„å…¬ç½‘ IPã€‚ä»¥ä¸‹æ˜¯å…·ä½“å®ç°çš„ä»£ç ï¼š

```golang
package main

import (
	"fmt"
	"io/ioutil"
	"net/http"
	"regexp"
)

// å®šä¹‰ IPv4 çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œç›®çš„æ˜¯ä»è·å–å…¬ç½‘ IP çš„  API è¿”å›ç»“æœä¸­è¿‡æ»¤å‡º IPv4 åœ°å€
const ipv4_regex = `(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}`

// å®šä¹‰å‡ ä¸ªå‡ ä¸ªæä¾›è·å–å…¬ç½‘ IPv4 åœ°å€çš„ API URL
var urlList = []string{
  "https://ip.me"
	"http://ip.sb",
	"http://ip.cip.cc",
	"http://myip.ipip.net",
}

func GetPublicIP() string {
	for _, url := range urlList {
    // åˆ›å»ºä¸€ä¸ª http client
		client := &http.Client{}
    // è®¾ç½® client çš„è¯·æ±‚æ–¹æ³•ä¸º GET ä»¥åŠè¯·æ±‚çš„ URL
		request, err := http.NewRequest("GET", url, nil)
		if err != nil {
			continue
		}
    // è®¾ç½® Client çš„ User-Agent ä¸º curlï¼Œä¸ç„¶ä¸€äº› API ä¼šè¿”å› html çš„ç»“æœ
		request.Header.Set("User-Agent", "curl/7.54.0")
		resp, err := client.Do(request)
		if resp.StatusCode != 200 && err != nil {
			continue
		}
		defer resp.Body.Close()
		body, err := ioutil.ReadAll(resp.Body)
    // ä» API è¿”å›ç»“æœä¸­ç”¨æ­£åˆ™åŒ¹é…å‡º IPv4 åœ°å€
		reg := regexp.MustCompile(ipv4_regex)
		ipList := reg.FindAllString(string(body), -1)
    // å¦‚æœåŒ¹é…ç»“æœä¸­æœ‰ IPv4 åœ°å€ï¼Œåˆ™è¿”å›ç¬¬ä¸€ä¸ªå…ƒç´ å³å¯
		if len(ipList) > 0 {
			fmt.Printf("my public ip is %s\n", ipList[0])
			return ipList[0]
		}
	}
	return ""
}
```

### æ·»åŠ  Firewall è§„åˆ™

```go
package main

import (
	"fmt"
	"os"

	"github.com/tencentcloud/tencentcloud-sdk-go/tencentcloud/common"
	"github.com/tencentcloud/tencentcloud-sdk-go/tencentcloud/common/errors"
	"github.com/tencentcloud/tencentcloud-sdk-go/tencentcloud/common/profile"
	lighthouse "github.com/tencentcloud/tencentcloud-sdk-go/tencentcloud/lighthouse/v20200324"
)

// å®šä¹‰ API è¯·æ±‚çš„ URL
const endpoint = "lighthouse.tencentcloudapi.com"

// å®šä¹‰è¯·æ±‚ API çš„ Client ç»“æ„ä½“
type Client struct {
	SecretId  string
	SecretKey string
	InstaceId string
	Region    string
	Endpoint  string
}

// é€šè¿‡è¯¥æ–¹æ³•ä»ç¯å¢ƒå˜é‡ä¸­è¯»å– Ck Sk ç­‰ä¿¡æ¯ï¼Œå¹¶è¿”å›ä¸€ä¸ª client å¯¹è±¡
func NewClient() Client {
	client := Client{
		SecretId:  os.Getenv("TENCENTCLOUD_SECRET_ID"),
		SecretKey: os.Getenv("TENCENTCLOUD_SECRET_KEY"),
		InstaceId: os.Getenv("TENCENTCLOUD_INSTANCE_ID"),
		Region:    os.Getenv("TENCENTCLOUD_REGION"),
		Endpoint:  endpoint,
	}
	if client.SecretId == "" || client.SecretKey == "" || client.InstaceId == "" || client.Region == "" {
		panic("Please set TENCENTCLOUD_SECRET_ID, TENCENTCLOUD_SECRET_KEY, TENCENTCLOUD_INSTANCE_ID, TENCENTCLOUD_REGION")
	}
	return client
}

// å®šä¹‰æ·»åŠ é˜²ç«å¢™è§„åˆ™çš„æ–¹æ³•
func (c Client) AddRules(firewallRules []*lighthouse.FirewallRule) {
	credential := common.NewCredential(c.SecretId, c.SecretKey)
	cpf := profile.NewClientProfile()
	cpf.HttpProfile.Endpoint = endpoint
	client, _ := lighthouse.NewClient(credential, c.Region, cpf)

	request := lighthouse.NewCreateFirewallRulesRequest()
	request.InstanceId = common.StringPtr(c.InstaceId)
	request.FirewallRules = firewallRules

	response, err := client.CreateFirewallRules(request)
	if _, ok := err.(*errors.TencentCloudSDKError); ok {
		fmt.Printf("An API error has returned: %s", err)
		return
	}
	if err != nil {
		panic(err)
	}
	fmt.Printf("%s", response.ToJsonString())
}
```

### è·å–é˜²ç«å¢™è§„åˆ™

```golang
func (c Client) GetRules() string {
	credential := common.NewCredential(c.SecretId, c.SecretKey)
	cpf := profile.NewClientProfile()
	cpf.HttpProfile.Endpoint = endpoint
	client, _ := lighthouse.NewClient(credential, c.Region, cpf)

	request := lighthouse.NewDescribeFirewallRulesRequest()

	request.InstanceId = common.StringPtr(c.InstaceId)

	response, err := client.DescribeFirewallRules(request)
	if _, ok := err.(*errors.TencentCloudSDKError); ok {
		fmt.Printf("An API error has returned: %s", err)
		return ""
	}
	if err != nil {
		panic(err)
	}
	return response.ToJsonString()
}
```

### ä½¿ç”¨

- åœ¨æœ¬åœ°çš„ `~/.bashrc` æˆ–è€… `~/.zshrc`æ–‡ä»¶ä¸­è®¾ç½®ä¸€äº› AKSKä¿¡æ¯ã€å®ä¾‹ IDã€region ä¿¡æ¯ç­‰å‚æ•°ï¼›

```bash
export TENCENTCLOUD_SECRET_ID="AKiiiplQntjJbcMp1"
export TENCENTCLOUD_SECRET_KEY="SKkkkiiwwlwjmmG5"
export TENCENTCLOUD_INSTANCE_ID="lhins-qjxazjaa"
export TENCENTCLOUD_REGION="ap-beijing"
```

- è®¾ç½®å¥½ç¯å¢ƒå˜é‡ä¹‹åï¼Œå†ç¼–è¯‘è¿è¡Œçœ‹ä¸‹èƒ½å¦æˆåŠŸ

```bash
$ go build -o cfwctl
$ chmod +x cfwctl
$ cfwctl add

my public ip is 193.191.231.82
{"Response":{"RequestId":"30e71243-1793-112e-9e41-b310ec599b90"}}%
```

- å¦‚æœæ˜¯ arm64 çš„ OpenWrt æ¢å°†ï¼Œåœ¨æœ¬åœ°å¼€å‘æœºä¸Šè¿›è¡Œè·¨å¹³å°ç¼–ï¼Œç„¶åå°†å®ƒ scp åˆ°è·¯ç”±å™¨ä¸Šï¼Œå†æ·»åŠ  cron job å®šæ—¶ä»»åŠ¡å³å¯

```bash
$ CGO_ENABLED=0  GOOS=linux  GOARCH=arm64 go build -o cfwctl
```



