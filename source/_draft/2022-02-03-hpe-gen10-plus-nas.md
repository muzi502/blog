---
title: All-in-one 之 HPE Gen10 Plus 服务器折腾记录
date: 2022-02-03
updated:
slug:
categories:
tag:
copyright: true
comment: true
---
去年裸辞离职的时候，将十四天的年假和调休假折算成了双倍的工资，瞬间让原本拮据的家庭富裕了一些。于是当时就购买一台种草很久的 NAS 服务器。

## 硬件篇

### CPU 升级

原装的 CPU 是 G5420，用来玩儿虚拟化有点弱不惊风；

### 内存升级

原装的内存是一根 ECC 8G DDR4，在内存可靠性和容量上我选择容量，毕竟

### HDD 硬盘

总共有四块 HDD 硬盘

并没有将四块盘采用 RAID5 的方式组成阵列；而是将两个 12T 的盘组成了 RAID1，用来存放重要的数据，一块 6T 的盘用于 iSCSI 存储，另一块 12T 的盘用于下载和同步的临时目录。

### NVMe 硬盘

### USB Dom 盘

将 ESXi 安装在 USB 盘上，

## 固件升级

## ESXi 安装

## NAS 虚拟机 OS 选择

### Debian

### TrueNAS

### DSM

## USB 控制器直通

## 磁盘共享

前面将 HBA 卡直通给 Debian 虚拟机之后，其他虚拟机就无法使用上面的硬盘了。又由于 NVMe 的 datastore 只有 512GB，不够虚拟机使用。比如我的 Windows 虚拟机需要一块 1TB 的硬盘

有两种方式，一种是使用 NFS 协议创建一个 datastore，然后再创建一块 1TB 的 VMDK 虚拟机磁盘给虚拟机使用；

### IOPS

|          | external  | external | internal  | internal |
| -------- | --------- | -------- | --------- | -------- |
| iosize   | writeiops | readiops | writeiops | readiops |
| 512      | 4096      | 11330    | 3491      | 5955     |
| 1024     | 12128     | 16458    | 4018      | 3225     |
| 2048     | 12165     | 16915    | 3004      | 3649     |
| 4096     | 12285     | 16995    | 4136      | 3009     |
| 8192     | 11633     | 14814    | 1677      | 1033     |
| 16384    | 8663      | 9466     | 856       | 1382     |
| 32768    | 8068      | 9900     | 1179      | 1162     |
| 65536    | 6341      | 7804     | 1057      | 1470     |
| 131072   | 2934      | 4367     | 1216      | 1650     |
| 262144   | 1495      | 2119     | 1041      | 1440     |
| 524288   | 684       | 1411     | 744       | 628      |
| 1048576  | 330       | 587      | 422       | 202      |
| 2097152  | 171       | 202      | 191       | 117      |
| 4194304  | 78        | 127      | 64        | 54       |
| 8388608  | 33        | 51       | 24        | 27       |
| 12582912 | 21        | 23       | 16        | 15       |
| 16777216 | 15        | 15       | 10        | 11       |
| 25165824 | 10        | 10       | 7         | 9        |
| 33554432 | 7         | 7        | 5         | 6        |
| 50331648 | 5         | 4        | 4         | 4        |
| 67108864 | 3         | 3        | 4         | 3        |

### BPS

|          | external  | external  | internal  | internal  |
| -------- | --------- | --------- | --------- | --------- |
| iosize   | writebps  | readbps   | writebps  | readbps   |
| 512      | 2097349   | 5800985   | 1787531   | 3049131   |
| 1024     | 12419801  | 16853865  | 4115366   | 3303225   |
| 2048     | 24914841  | 34642786  | 6152789   | 7474452   |
| 4096     | 50319410  | 69611822  | 16942092  | 12325925  |
| 8192     | 95302970  | 121362962 | 13739203  | 8462809   |
| 16384    | 141940594 | 155091262 | 14033404  | 22650691  |
| 32768    | 264387286 | 324435643 | 38641509  | 38102325  |
| 65536    | 415594146 | 511500487 | 69276955  | 96376470  |
| 131072   | 384635665 | 572498390 | 159454987 | 216392452 |
| 262144   | 392095726 | 555603853 | 273066666 | 377573662 |
| 524288   | 359101369 | 740171294 | 390288833 | 329740880 |
| 1048576  | 346636694 | 615903671 | 443372515 | 211833535 |
| 2097152  | 360335395 | 424811343 | 402524376 | 247159929 |
| 4194304  | 331303633 | 536356010 | 268693401 | 227827485 |
| 8388608  | 284842376 | 431290899 | 205653542 | 228697055 |
| 12582912 | 264569217 | 294543820 | 213704347 | 199191261 |
| 16777216 | 257952275 | 256336378 | 181062119 | 199088833 |
| 25165824 | 257579166 | 255018661 | 197998592 | 233440958 |
| 33554432 | 257994731 | 256262965 | 200021762 | 224221733 |
| 50331648 | 257685982 | 250340657 | 217039763 | 251144202 |
| 67108864 | 255538735 | 258538287 | 279302051 | 249272623 |
