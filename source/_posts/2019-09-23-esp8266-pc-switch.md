---
title: ä½¿ç”¨ ESP8266 NodeMCU æ‰“é€  WiFi å¼€å…³
date: 2019-09-23
categories: æŠ€æœ¯
slug:
tag:
  - ESP8266
  - åµŒå…¥å¼
copyright: true
comment: true
---

åœ¨åŠå…¬å®¤å¸Œæœ›è¿æ¥åˆ°å®¶é‡Œçš„ç”µè„‘ï¼Œå†…ç½‘ç©¿é€æ–¹æ¡ˆé€‰çš„æ˜¯ frpï¼Œä½†å®¶é‡Œçš„ç”µè„‘åœ¨èµ°çš„æ—¶å€™ä¼šå¿˜è®°æ‰“å¼€ï¼Œäº¦æˆ–è€…æ­»æœºè“å±çš„æ—¶å€™å‡ºç°æ•…éšœæ— æ³•æ‰‹åŠ¨é‡å¯ã€‚æ­£å¥½æ‰‹å¤´é‡Œæœ‰ä¸¤å°è·¯ç”±å™¨ï¼Œä¸€å° `R6300 V2` åˆ·äº†æ¢…æ—å›ºä»¶ï¼Œä¸€å° `WNDR 3700 V4` åˆ·äº† `OpenWRT`  ï¼Œå¦å¤–è¿˜æœ‰ä¸€å— `ESP8266 NodeMcu Lua WIFI V3 ESP-12N` çš„æ¿å­ã€‚å¦å¤–è¿˜éœ€è¦ä¸€ä¸ª 3.3 v/5v çš„ç»§ç”µå™¨ï¼ŒæŸå®ä¸Š 3.9 åŒ…é‚®ã€‚

æ–¹æ¡ˆå›¾

## è·¯ç”±å™¨æ§åˆ¶ USB ç”µæºå¼€å…³

å…¶å®æˆ‘ç¬¬ä¸€ä¸ªæƒ³åˆ°çš„æ–¹æ¡ˆå°±æ˜¯ç›´æ¥é€šè¿‡è·¯ç”±å™¨çš„ USB æ¥å£æ§åˆ¶ç»§ç”µå™¨æ¥æ§åˆ¶ PC ä¸»æ¿å¼€å…³ï¼Œç½‘ä¸Šä¹Ÿæœ‰æ–‡ç« å¯ä»¥é€šè¿‡ echo å‘½ä»¤æ§åˆ¶ USB ç”µæºã€‚Linux å†…æ ¸å®˜æ–¹ç½‘ä¹Ÿæœ‰è¯´æ˜ [Power Management for USB](https://www.kernel.org/doc/Documentation/usb/power-management.txt)

[Turning USB power on and off](https://openwrt.org/docs/guide-user/hardware/usb.overview) è¿™ä¸ªæ˜¯é€šè¿‡ GPIO å¼•è„šé©±åŠ¨æ¥æ§åˆ¶çš„

```bash
# æ‰“å¼€ç”µæº
echo 1 > /sys/class/gpio/gpioN/value
# å…³é—­ç”µæº
echo 0 > /sys/class/gpio/gpioN/value
```

ä½†æˆ‘çš„ R6300V2 ä¸Šæ²¡æœ‰è¿™äº› GPIO çš„å¼•è„šè®¾å¤‡æ–‡ä»¶

```bash
lede@R6300V2-5501:/tmp/home/root# tree /sys/class/gpio/
/sys/class/gpio/
â””â”€â”€ gpio
    â”œâ”€â”€ dev
    â”œâ”€â”€ subsystem -> ../../gpio
    â””â”€â”€ uevent
lede@R6300V2-5501:/sys/class/gpio/gpio# cat dev
254:0
lede@R6300V2-5501:/sys/class/gpio/gpio# cat uevent
MAJOR=254
MINOR=0
DEVNAME=gpio
```

æ— åŠŸè€Œè¿”ï¼Œæœ€ååœ¨åˆæ‰¾åˆ°äº†å¦å¤–ä¸€ç§é€šè¿‡å‘½ä»¤è¡Œæ¥æ§åˆ¶ USB ç”µæºå¼€å…³çš„åŠæ³• [Controlling a USB power supply (on/off) with linux](https://stackoverflow.com/questions/4702216/controlling-a-usb-power-supply-on-off-with-linux)

```bash
# disable external wake-up; do this only once
echo disabled > /sys/bus/usb/devices/usb1/power/wakeup

echo on > /sys/bus/usb/devices/usb1/power/level       # turn on
echo suspend > /sys/bus/usb/devices/usb1/power/level  # turn off
```

ä½†æˆ‘çš„ R6300V2 è·¯ç”±å™¨é‡Œä¹Ÿæ²¡æœ‰è¿™ä¸ªæ–‡ä»¶ï¼Œæ— åŠŸè€Œè¿”ã€‚ä½†åœ¨è¿™ä¸ª USB è®¾å¤‡æ–‡ä»¶é‡Œå´å‘ç°äº†æœ‰æ„æ€çš„äº‹æƒ…

```bash
lede@R6300V2-5501:/tmp/home/root# ls -al /sys/bus/usb/devices/ | awk '{print $9,$10,$11}'
./
../
1-0:1.0 -> ../../../devices/pci0000:00/0000:00:0b.1/usb1/1-0:1.0/
1-1 -> ../../../devices/pci0000:00/0000:00:0b.1/usb1/1-1/
1-1:1.0 -> ../../../devices/pci0000:00/0000:00:0b.1/usb1/1-1/1-1:1.0/
2-0:1.0 -> ../../../devices/pci0000:00/0000:00:0b.0/usb2/2-0:1.0/
usb1 -> ../../../devices/pci0000:00/0000:00:0b.1/usb1/
usb2 -> ../../../devices/pci0000:00/0000:00:0b.0/usb2/
lede@R6300V2-5501:/tmp/home/root#
```

R6300V2 æ”¯æŒçš„ USB è®¾å¤‡ç±»å‹é©±åŠ¨æœ‰ä»¥ä¸‹å‡ ç§

```bash
lede@R6300V2-5501:/sys/bus/usb/drivers# ls
asix/        cdc_mbim/    cdc_wdm/     qmi_wwan/    usb/         usbfs/
cdc_ether/   cdc_ncm/     hub/         rndis_host/  usb-storage/ usblp/
```

è™½ç„¶ R6300V2 å·ç§°æœ‰ä¸€ä¸ª USB3.0 å’Œä¸€ä¸ª USB2.0 ï¼Œä½†è®¾å¤‡é€Ÿåº¦è¿˜æ˜¯ 480Mbps ï¼ŒUSB2.0 çš„é€Ÿåº¦ï¼Œä¸æ˜ç™½è¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿä½¿ç”¨ dd æµ‹äº†ä¸€ä¸‹é€Ÿåº¦ï¼Œ

```bash
lede@R6300V2-5501:/sys/devices/pci0000:00/0000:00:0b.1/usb1# cat speed
480
```

## è¿˜æ˜¯ç”¨åƒç°çš„  ESP8266 ğŸ˜‚

å°è¯•äº†å¤šç§åŠæ³•è¯•ç€ä½¿ç”¨è·¯ç”±å™¨çš„ USB å£å½“ç»§ç”µå™¨çš„æ§åˆ¶ç«¯ï¼Œå‡æ— åŠŸè€Œè¿”ï¼Œçœ‹æ¥æ˜¯ä¸èƒ½ä½¿ç”¨è·¯ç”±å™¨æ¥æäº†ã€‚æ­£å¥½æ‰‹é‡Œè¿˜æœ‰ä¸€å— `ESP8266 NodeMcu Lua WIFI V3 ESP-12N` ï¼Œå¤§äºŒæ—¶å¥½å¥‡å°±å…¥æ‰‹äº†ä¸€å—æ WiFi æ”»å‡»äº† ğŸ˜‚ï¼Œç©äº†å‡ æ¬¡ä¸€ç›´åœ¨åƒç°äº†ï¼Œä»Šå¤©ç»ˆäºæ´¾ä¸Šç”¨åœºäº†ã€‚

```c
#include <ESP8266WiFi.h>
#include <WiFiClient.h>
#include <ESP8266WebServer.h>

//è®¾ç½®è·¯ç”±å™¨å’Œé™æ€ IP
const char* ssid = " ";
const char* password = " ";
IPAddress staticIP(192, 168, 0, 230);
IPAddress gateway(192, 168, 0, 1);
IPAddress subnet(255, 255, 255, 0);

// web æœåŠ¡å™¨ç›‘å¬ç«¯å£
ESP8266WebServer server(80);

// å®šä¹‰ç›¸å…³æ§åˆ¶é’ˆè„š
const int LED = 13;
const int SW = 14;

// å®šä¹‰è®¤è¯ç”¨æˆ·å’Œå¯†ç 
const char* user = "esp8266";
const char* pass = "esp8266";
const char* realm = "Custom Auth Realm";
String authFailResponse = "Authentication Failed";
const char MAIN_page[] PROGMEM = R"=====(
<!DOCTYPE html><html><body><a href="pcon">PC POWER TRUN ON</a><br><a href="pcoff">PC POWER TRUN OFF</a></body></html>
)=====";

void handleRoot() {
    Serial.println("GET INDEX PAGE");
    String s = MAIN_page;
    server.send(200, "text/html", s);
}

void handlePCon() {
 Serial.println("LED on page");
 digitalWrite(LED,LOW); //LED
 digitalWrite(SW,LOW); //LED
 delay(800);
 digitalWrite(SW,HIGH);
 server.send(200, "text/html", "LED is ON");
}

void handlePCoff() {
 Serial.println("LED off page");
 digitalWrite(LED,HIGH); //LED off
 digitalWrite(SW,HIGH); //LED off
 server.send(200, "text/html", "LED is OFF"); //Send ADC value only to client ajax request
}

void setup(void) {
    pinMode(LED, OUTPUT);
    digitalWrite(LED, 0);
    pinMode(SW, OUTPUT);
    digitalWrite(SW, 1);
    Serial.begin(115200);
    WiFi.begin(ssid, password);
    WiFi.config(staticIP, subnet, gateway);
    WiFi.mode(WIFI_STA);
    Serial.println("");

  // Wait for connection
    while (WiFi.status() != WL_CONNECTED) {
        delay(500);
        Serial.print(".");
    }
    Serial.println("");
    Serial.print("Connected to ");
    Serial.println(ssid);
    Serial.print("IP address: ");
    Serial.println(WiFi.localIP());

    server.on("/", []() {
        if (!server.authenticate(user,pass))
        return server.requestAuthentication(DIGEST_AUTH, realm, authFailResponse);
        Serial.println("GET INDEX PAGE");
        String s = MAIN_page;
        server.send(200, "text/html", s);
   });
   server.on("/pcon",[]() {
        if (!server.authenticate(user,pass))
        return server.requestAuthentication(DIGEST_AUTH, realm, authFailResponse);
        Serial.println("PC POWER TRUN ON");
        digitalWrite(LED,LOW);
        digitalWrite(SW,LOW);
        delay(800);
        digitalWrite(SW,HIGH);
        server.send(200, "text/html", "PC POWER TRUN ON");
   });
   server.on("/pcoff", []() {
        if (!server.authenticate(user,pass))
        return server.requestAuthentication(DIGEST_AUTH, realm, authFailResponse);
        Serial.println("PC POWER TRUN OFF");
        digitalWrite(LED,HIGH); //LED off
        digitalWrite(SW,HIGH); //LED off
        server.send(200, "text/html", "PC POWER TRUN OFF");
   });
   server.on("/pcon", handlePCon);
   server.on("/pcoff", handlePCoff);
   server.begin();
   Serial.println("HTTP server started");
}
void loop(void) {
  server.handleClient();
}
```

æœ¬æ¥ç¬¬ä¸€ç‰ˆå†™çš„å¾ˆå¤æ‚ï¼Œè¿˜æ•´äº†ä¸ª HTML  é¡µé¢ï¼ŒåŠ äº†ä¸ªæƒé™è®¤è¯ä»€ä¹ˆçš„ï¼Œæ‚ä¸ƒæ‚å…«çš„çš„ï¼Œæœ€åè¿˜æ˜¯å…¨éƒ½å»æ‰äº†ï¼Œå› ä¸ºå¼€æœºçš„è¯æˆ‘ä¹ æƒ¯äºå‘½ä»¤è¡Œï¼Œè¿˜æ˜¯ç›´æ¥åœ¨è·¯ç”±å™¨ä¸Šä½¿ç”¨ä¸€ä¸ª curl å‘½ä»¤å°±èƒ½æå®šï¼ˆå·²é…ç½®å¥½ frp å†…ç½‘ç©¿é€ï¼‰ã€‚å¦å¤–åœ¨è·¯ç”±å™¨ä¸Šé…ç½®å¥½é˜²ç«å¢™è§„åˆ™ï¼Œä»…å…è®¸è·¯ç”±å™¨æœ¬æœº IP è®¿é—®  ESP8266 çš„ IPï¼Œè¿™æ ·å°±å…å»çš„è®¤è¯çš„éº»çƒ¦ï¼Œçœäº‹å„¿ ğŸ˜‚ã€‚ä¸ºäº†å®‰å…¨èµ·è§ï¼Œå°±æ²¡æœ‰æŠŠ ESP8266 ç›‘å¬çš„ç«¯å£å†…ç½‘ç©¿é€åˆ°æˆ‘çš„æœåŠ¡å™¨ã€‚æˆ‘ä¸€èˆ¬éƒ½æ˜¯é€šè¿‡ frp è¿æ¥åˆ°æˆ‘å®¶é‡Œçš„è·¯ç”±å™¨ï¼Œç„¶åå†åœ¨ä¸Šé¢æ“ä½œï¼Œå½“ç„¶å†™äº†åˆ«åå°±æ›´æ–¹ä¾¿äº†ã€‚
