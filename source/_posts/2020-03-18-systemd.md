---
title: Linux çš„å°ä¼™ä¼´ systemd è¯¦è§£
date: 2020-03-19
updated: 2020-03-19
slug:
categories: æŠ€æœ¯
tag:
  - Linux
  - blog
  - ç¬”è®°
copyright: true
comment: true
---

## å°æ’æ›²

æœ€è¿‘ [åœŸè±†å“¥](https://www.bennythink.com/) åœ¨æ£é¼“ [Webp Server Go](https://github.com/webp-sh/webp_server_go) çš„æ—¶å€™å‘å’±ä¸€å¼  `systemctl status webp` çš„ä¿¡æ¯ï¼š

![](https://p.k8s.li/20200318080736564.png)

å’¦ï¼Ÿå’±çš„ `systemctl status webp` ä¸ºå•¥å­æ²¡å¾— CPU å’Œ Memory ä¿¡æ¯å‘ï¼Ÿ

![](https://p.k8s.li/20200318080903595.png)

ç„¶åå’ŒåœŸè±†å“¥è¯·æ•™äº†ä¸€ä¸‹ï¼Œå’±ä¹Ÿæƒ³è¦ã€‚äºæ˜¯åœŸè±†å“¥å‘å’±ä¸€ç¯‡ [systemd â€“ systemctl ä¸æ˜¾ç¤ºå†…å­˜ CPU ä¿¡æ¯](https://www.bennythink.com/systemd-accounting.html) åšå®¢ï¼Œäºæ˜¯æ‹œå¸ˆå­¦è‰ºå°± get åˆ°å•¦ğŸ˜‹ã€‚åªéœ€è¦åœ¨ systemd çš„é…ç½®æ–‡ä»¶ä¸­ `/etc/systemd/system.conf` è¿½åŠ 

```ini
DefaultCPUAccounting=yes
DefaultMemoryAccounting=yes
DefaultTasksAccounting=yes
```

ç„¶åå† `systemctl daemon-reload` ä¸€æŠŠæ¢­å°±å¯ä»¥å•¦ğŸ˜‚

```shell
â•­â”€root@blog /home/ubuntu
â•°â”€# systemctl status webps
â— webps.service - WebP Server
   Loaded: loaded (/opt/webps/webps.service; enabled; vendor preset: enabled)
   Active: active (running) since Sat 2020-03-14 10:32:31 UTC; 4 days ago
     Docs: https://github.com/n0vad3v/webp_server_go
 Main PID: 20691 (webp-server)
    Tasks: 36 (limit: 684)
   Memory: 9.1M
      CPU: 20.421s
   CGroup: /system.slice/webps.service
           â””â”€20691 /opt/webps/webp-server --config /opt/webps/config.json
```

![](https://p.k8s.li/20200318211715509.png)

ä¸è¿‡ï¼Œå’±è¿˜æ˜¯è¦æ·±å…¥åœ°å­¦ä¹ ä¸€ä¸‹ `systemd` ï¼Œäºæ˜¯å°±æ°´äº†è¿™ç¯‡åšå®¢ğŸ˜‚

## Linux å¯åŠ¨æµç¨‹

æåˆ° systemd ä¸å¾—ä¸æä¸€ä¸‹ Linux çš„å¯åŠ¨æµç¨‹ï¼Œè¿™æ ·æ‰èƒ½æ¸…æ¥š  systemd åœ¨ Linux ç³»ç»Ÿä¸­çš„åœ°ä½å’Œä½œç”¨ğŸ˜‹ã€‚æ‰€ä»¥å°±ç®€æ˜æ‰¼è¦ç¬¬ä»‹ç»ä¸€ä¸‹ Linux å¯åŠ¨çš„æµç¨‹ã€‚

Linux ä»æŒ‰ä¸‹ç”µæºé”®åˆ°è¿›å…¥ç”¨æˆ·äº¤äº’ç•Œé¢æ•´ä¸ªå¯åŠ¨æµç¨‹å¤§è‡´å¯ä»¥åˆ†ä¸ºå››ä¸ªé˜¶æ®µï¼š

- BIOS é˜¶æ®µ

- BootLoader é˜¶æ®µ

- kernel åŠ è½½é˜¶æ®µ

- initï¼šsystemd/sysvinit åˆå§‹åŒ–é˜¶æ®µ

### BIOS/EFI é˜¶æ®µ

BIOS æƒ³å¿…å¤§å®¶éƒ½ç†Ÿæ‚‰ï¼Œä¹Ÿå°±æ˜¯åšä¸€äº›åŸºæœ¬çš„ç¡¬ä»¶è‡ªæ£€å‡†å¤‡ä»¥åŠåŠ è½½ bootloader ç¨‹åºã€‚åœ¨æŒ‰ä¸‹ç”µæºç”µæºé”®ï¼ˆå†·å¯åŠ¨ï¼‰åï¼Œ CPU çš„ç¨‹åºè®¡æ•°å™¨è¢«åˆå§‹åŒ–ä¸ºä¸€ä¸ªç‰¹å®šçš„å…§å­˜åœ°å€ï¼Œå­˜å‚¨åœ¨åªè¯»å­˜å‚¨å™¨ï¼ˆROMï¼‰ä¸­çš„ BIOS å°±æ˜¯ä»è¿™ä¸ªç‰¹å®šçš„å…§å­˜åœ°å€å¼€å§‹æ‰§è¡Œã€‚**æ‰€ä»¥æ²¡æœ‰ CPU æ˜¯æ— æ³•å¯åŠ¨ä¸»æ¿ä¸Šçš„ BIOS çš„** ï¼Œåº”è¯¥ï¼ˆå°å£°ã€‚æ³¨æ„ï¼šå¯¹äºåµŒå…¥å¼ç³»ç»Ÿä¸­çš„ CPU ï¼Œå°†ä¼šåŠ è½½å¼•å¯¼åŒºå»å¯åŠ¨ flash/ROM ä¸­å·²çŸ¥åœ°å€çš„ç¨‹åºã€‚

BIOS å¯åŠ¨åå°±å¼€å§‹æ‰§è¡Œç¡¬ä»¶çš„åŸºæœ¬åˆå§‹åŒ–ä¹Ÿç§°ä¹‹ä¸ºï¼ˆPOST: ä¸Šç”µè‡ªæ£€ï¼‰ï¼Œå¹¶æ ¹æ®å¼•å¯¼è®¾å¤‡çš„ä¼˜å…ˆçº§å°†ç³»ç»Ÿæ§åˆ¶æƒäº¤ç»™ç¡¬ä»¶å¯åŠ¨é¡¹ï¼ˆæ¯”å¦‚ç¡¬ç›˜/ç½‘ç»œ/Uç›˜ç­‰ï¼‰ã€‚ä¹Ÿå°±æ˜¯æˆ‘ä»¬ BIOS ä¸Šçš„å¯åŠ¨èœå•ï¼Œè¿™ä¸€æ­¥æ˜¯å¯ä»¥è¢«æ‰“æ–­çš„ã€‚å½“æˆ‘ä»¬æŒ‰ä¸‹ F12 æˆ–è€… ESC é”®ï¼ˆæ ¹æ®ä¸»æ¿èŠ¯ç‰‡ç»„è€Œå¼‚ï¼‰å°±ä¼šå¼¹å‡ºé€‰æ‹©å¯åŠ¨é¡¹çš„ç•Œé¢ï¼Œè€Œä¸”è¿™äº›æŒ‰é”®é«˜åº¦ä¾èµ–ç¡¬ä»¶ã€‚

BIOS é€‰æ‹©å¥½ç¡¬ä»¶å¯åŠ¨é¡¹ä¹‹åå°±å¼€å§‹æ‰§è¡Œç¡¬ä»¶è®¾å¤‡ä¸Šçš„åˆçº§å¼•å¯¼ç¨‹åºä»£ç ï¼Œå¯¹äº MBR ç¡¬ç›˜æ¥è®²æ˜¯æœ€å¼€å§‹çš„ä¸€ä¸ªæ‰‡åŒºï¼ˆ512å­—èŠ‚ï¼‰å°‡è¢«åŠ è½½åˆ°å…§å­˜ï¼Œä¸¦æ‰§è¡Œè¡Œå…¶ä¸­çš„åˆå§‹åŒ–ä»£ç æ¥åŠ è½½ä¸‹ä¸€é˜¶æ®µçš„ Bootloader ã€‚

PSï¼šMBR **ä¸»å¼•å¯¼è®°å½•**æ˜¯ä¸€ä¸ª 512 å­—èŠ‚çš„æ‰‡åŒºï¼Œä½äºç¡¬ç›˜çš„ç¬¬ä¸€æ‰‡åŒºï¼ˆ0é“0æŸ±1æ‰‡åŒºï¼‰ã€‚å¯¹äº GPT/EFI æ¥è®²~~ï¼Œæœ‰ç‚¹å¤´å¤§ï¼Œæš‚ä¸”å…ˆä¸è°ˆğŸ˜‚ã€‚

å¯ä»¥ä½¿ç”¨ dd å‘½ä»¤è¯»å– MBR é‡Œçš„å†…å®¹ `dd if=/dev/sda of=mbr.bin bs=512 count=1`

ä½¿ç”¨ od å‘½ä»¤æ¥æŸ¥çœ‹ `od -xa mbr.bin`

```shell
# od -xa mbr.bin
0000000    63eb    0090    0000    0000    0000    0000    0000    0000
          k   c dle nul nul nul nul nul nul nul nul nul nul nul nul nul
0000020    0000    0000    0000    0000    0000    0000    0000    0000
        nul nul nul nul nul nul nul nul nul nul nul nul nul nul nul nul
*
0000120    0000    0000    0000    0000    0000    8000    0800    0000
        nul nul nul nul nul nul nul nul nul nul nul nul nul  bs nul nul
0000140    0000    0000    faff    9090    c2f6    7480    f605    70c2
        nul nul nul nul del   z dle dle   v   B nul   t enq   v   B   p
0000160    0274    80b2    79ea    007c    3100    8ec0    8ed8    bcd0
          t stx   2 nul   j   y   | nul nul   1   @  so   X  so   P   <
0000200    2000    a0fb    7c64    ff3c    0274    c288    bb52    0417
        nul  sp   {  sp   d   |   < del   t stx  bs   B   R   ; etb eot
0000220    07f6    7403    be06    7d88    17e8    be01    7c05    41b4
          v bel etx   t ack   >  bs   }   h etb soh   > enq   |   4   A
0000240    aabb    cd55    5a13    7252    813d    55fb    75aa    8337
â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦
```

### BootLoader é˜¶æ®µ

ä¸»å¼•å¯¼è®°å½•åŠ è½½å®Œ Bootloaderï¼ˆä¸»è¦ä¸ºGRUBï¼‰åˆ° RAM ä¸­ä¹‹åï¼ŒGRUB ä¼šæ ¹æ®éœ€æ±‚æ˜¾ç¤ºä¸€ä¸ªå¯ç”¨çš„å†…æ ¸åˆ—è¡¨ï¼ˆå®šä¹‰åœ¨/etc/grub.confï¼Œä»¥åŠ/etc/grub/menu.lstå’Œ/etc/grub.confçš„è½¯è¿æ¥ï¼‰ã€‚æ ¹æ® GRUB çš„é…ç½®åŠ è½½é»˜è®¤å†…æ ¸é•œåƒå’Œ initrd é•œåƒåˆ°å†…å­˜ä¸­ï¼Œå½“æ‰€æœ‰é•œåƒå‡†å¤‡å¥½åï¼Œå³è·³è½¬åˆ°å†…æ ¸é•œåƒã€‚

### kernel é˜¶æ®µ

BootLoader é˜¶æ®µå®Œæˆä¹‹åå†…æ ¸é•œåƒåŠ è½½åˆ°å†…å­˜ä¸­ï¼Œç³»ç»Ÿçš„æ§åˆ¶æƒå°±äº¤ç»™å†…æ ¸é•œåƒï¼Œç”±æ­¤å†…æ ¸é˜¶æ®µå¼€å§‹äº†ã€‚å†…æ ¸é•œåƒä¸æ˜¯ä¸€ä¸ªå¯ä»¥æ‰§è¡Œçš„å†…æ ¸ï¼Œè€Œæ˜¯ä¸€ä¸ªè¢«å‹ç¼©çš„å†…æ ¸é•œåƒ ï¼ˆzImage æˆ– bzImageï¼‰ã€‚åœ¨å†…æ ¸é•œåƒçš„å¤´éƒ¨æœ‰ä¸€ä¸ªå°å‹ç¨‹åº routine ï¼Œå…¶åšå°‘é‡çš„ç¡¬ä»¶è®¾ç½®ï¼Œç„¶åè‡ªè§£å‹å‹ç¼©çš„å†…æ ¸é•œåƒå¹¶æ”¾åˆ°é«˜ç«¯å†…å­˜ã€‚å¦‚æœå­˜åœ¨åˆå§‹ç£ç›˜é•œåƒï¼ˆinitrdï¼‰ï¼Œroutine å°†æ‹·è´ initrd ä»¥ä¾›ç¨åå®‰è£…ä½¿ç”¨ï¼Œç„¶å routine å°†è°ƒç”¨å†…æ ¸å¼€å§‹å†…æ ¸å¯åŠ¨ã€‚

> åœ¨å†…æ ¸å¼•å¯¼è¿‡ç¨‹ä¸­ï¼Œåˆå§‹ RAM ç£ç›˜ï¼ˆinitrdï¼‰æ˜¯ç”± BootLoader åŠ è½½åˆ°å†…å­˜ä¸­çš„ï¼Œå®ƒä¼šè¢«å¤åˆ¶åˆ° RAM ä¸­å¹¶æŒ‚è½½åˆ°ç³»ç»Ÿä¸Šã€‚è¿™ä¸ª initrd ä½œä¸º RAM ä¸­çš„ä¸´æ—¶æ ¹æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨ï¼Œå¹¶å…è®¸å†…æ ¸åœ¨æ²¡æœ‰æŒ‚è½½ä»»ä½•ç‰©ç†ç£ç›˜çš„æƒ…å†µä¸‹å®Œæ•´åœ°å®ç°å¼•å¯¼ã€‚ç”±äºä¸å¤–å›´è®¾å¤‡è¿›è¡Œäº¤äº’æ‰€éœ€è¦çš„æ¨¡å—å¯æ˜¯ initrd çš„ä¸€éƒ¨åˆ†ï¼Œå› æ­¤å†…æ ¸å¯ä»¥éå¸¸å°ï¼Œä½†æ˜¯ä»ç„¶æ”¯æŒå¤§é‡å¯èƒ½çš„ç¡¬ä»¶é…ç½®ã€‚åœ¨å†…æ ¸å¯åŠ¨åï¼Œå°±å¯ä»¥æ­£å¼è£…å¤‡æ ¹æ–‡ä»¶ç³»ç»Ÿäº†ï¼ˆé€šè¿‡ pivot_rootï¼‰ï¼Œæ­¤æ—¶ä¼šå°† initrd æ ¹æ–‡ä»¶ç³»ç»Ÿå¸è½½æ‰ï¼Œå¹¶æŒ‚è½½çœŸæ­£çš„æ ¹æ–‡ä»¶ç³»ç»Ÿã€‚
> initrd å‡½æ•°è®©æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªå°å‹çš„ Linux å†…æ ¸ï¼Œå…¶ä¸­åŒ…æ‹¬ä½œä¸ºå¯åŠ è½½æ¨¡å—ç¼–è¯‘çš„é©±åŠ¨ç¨‹åºã€‚è¿™äº›å¯åŠ è½½çš„æ¨¡å—ä¸ºå†…æ ¸æä¾›äº†è®¿é—®ç£ç›˜å’Œç£ç›˜ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿçš„æ–¹æ³•ï¼Œå¹¶ä¸ºå…¶ä»–ç¡¬ä»¶æä¾›äº†é©±åŠ¨ç¨‹åºã€‚ç”±äºæ ¹æ–‡ä»¶ç³»ç»Ÿæ˜¯ç£ç›˜ä¸Šçš„ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œå› æ­¤ initrd å‡½æ•°ä¼šæä¾›ä¸€ç§å¯åŠ¨æ–¹æ³•æ¥è·å¾—å¯¹ç£ç›˜çš„è®¿é—®ï¼Œå¹¶æŒ‚è½½çœŸæ­£çš„æ ¹æ–‡ä»¶ç³»ç»Ÿã€‚åœ¨æ²¡æœ‰ç¡¬ç›˜çš„åµŒå…¥å¼ç›®æ ‡ä¸­ï¼Œinitrd å¯ä»¥æ˜¯æœ€ç»ˆçš„æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œæˆ–è€…ä¹Ÿå¯ä»¥é€šè¿‡ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿï¼ˆNFSï¼‰æ¥æŒ‚è½½æœ€ç»ˆçš„æ ¹æ–‡ä»¶ç³»ç»Ÿã€‚

å¯ä»¥ä½¿ç”¨ dmesg æ¥æŸ¥çœ‹ä»åŠ è½½å†…æ ¸åçš„æµç¨‹ï¼Œä¸‹ä¸€ç¯‡åšå®¢ä¼šå†™ä» dmesg æ—¥å¿—åˆ†æ Linux å†…æ ¸å¯åŠ¨æµç¨‹ï¼ˆæŒ–å‘

```shell
â•­â”€root@blog /home/ubuntu
â•°â”€# dmesg
[    0.000000] Linux version 5.0.0-1031-gcp (buildd@lcy01-amd64-020) (gcc version 7.4.0 (Ubuntu 7.4.0-1ubuntu1~18.04.1)) #32-Ubuntu SMP Tue Feb 11 03:55:48 UTC 2020 (Ubuntu 5.0.0-1031.32-gcp 5.0.21)
[    0.000000] Command line: BOOT_IMAGE=/boot/vmlinuz-5.0.0-1031-gcp root=PARTUUID=9b22aacc-c8b9-497a-9583-a20c1be968c4 ro scsi_mod.use_blk_mq=Y console=ttyS0
[    0.000000] KERNEL supported cpus:
[    0.000000]   Intel GenuineIntel
[    0.000000]   AMD AuthenticAMD
[    0.000000]   Hygon HygonGenuine
[    0.000000]   Centaur CentaurHauls
â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦
[    2.486896] Write protecting the kernel read-only data: 22528k
[    2.489395] Freeing unused kernel image memory: 2016K
[    2.490937] Freeing unused kernel image memory: 1708K
[    2.500867] x86/mm: Checked W+X mappings: passed, no W+X pages found.
[    2.503126] x86/mm: Checking user space page tables
[    2.513767] x86/mm: Checked W+X mappings: passed, no W+X pages found.
[    2.516258] Run /sbin/init as init process
[    3.992535] systemd[1]: systemd 237 running in system mode. (+PAM +AUDIT +SELINUX +IMA +APPARMOR +SMACK +SYSVINIT +UTMP +LIBCRYPTSETUP +GCRYPT +GNUTLS +ACL +XZ +LZ4 +SECCOMP +BLKID +ELFUTILS +KMOD -IDN2 +IDN -PCRE2 default-hierarchy=hybrid)
[    4.002297] systemd[1]: Detected virtualization kvm.
[    4.004593] systemd[1]: Detected architecture x86-64.
[    4.031531] systemd[1]: Set hostname to <blog>.
[    5.343604] systemd[1]: Reached target Swap.
[    5.355156] systemd[1]: Started Dispatch Password Requests to Console Directory Watch.
[    5.367360] systemd[1]: Created slice User and Session Slice.
[    5.379321] systemd[1]: Set up automount Arbitrary Executable File Formats File System Automount Point.
[    5.395189] systemd[1]: Started Forward Password Requests to Wall Directory Watch.
[    5.411078] systemd[1]: Reached target Local Encrypted Volumes.
[    5.644759] EXT4-fs (sda1): re-mounted. Opts: (null)
[   11.663490] bpfilter: Loaded bpfilter_umh pid 456
```

### init åˆå§‹åŒ–é˜¶æ®µ

ä¸€æ—¦å†…æ ¸è‡ªè§£å‹å®Œæˆï¼Œå¯åŠ¨å¹¶åˆå§‹åŒ–åï¼Œå†…æ ¸å¯åŠ¨ç¬¬ä¸€ä¸ª**ç”¨æˆ·ç©ºé—´åº”ç”¨ç¨‹åº**ï¼Œå³ systemd è¿›ç¨‹ï¼ˆå…¶æ˜¯è€å¼ System V ç³»ç»Ÿçš„ init ç¨‹åºçš„æ›¿ä»£å“)ï¼Œå¹¶è½¬ç§»æ§åˆ¶æƒåˆ° systemdã€‚è¿™æ˜¯è°ƒç”¨çš„ç¬¬ä¸€ä¸ªä½¿ç”¨æ ‡å‡† C åº“ç¼–è¯‘çš„ç¨‹åºï¼Œåœ¨æ­¤è¿›ç¨‹ä¹‹å‰ï¼Œè¿˜æ²¡æœ‰æ‰§è¡Œä»»ä½•æ ‡å‡†çš„ C åº”ç”¨ç¨‹åºã€‚è‡³æ­¤æ•´ä¸ªç³»ç»Ÿå¼•å¯¼è¿‡ç¨‹çš„ç»“æŸï¼Œkernelå’Œ systemd å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œæ¥ä¸‹æ¥å°±ç”± systemd æ¥å¯åŠ¨å„é¡¹ç¨‹åºã€‚

ä» dmesg çš„è¾“å‡ºæ—¥å¿—æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç›´åˆ° 2.516258 ç§’æ‰å¼€å§‹æ‰§è¡Œ `/sbin/init` å‘½ä»¤ï¼Œè€Œå¯¹äºé‡‡ç”¨ systemd çš„å‘è¡Œç‰ˆæ¥è¯´ï¼Œ`/sbin/init` æ˜¯æŒ‡å‘ `/sbin/init -> /lib/systemd/systemd` ï¼Œçš„é“¾æ¥æ–‡ä»¶ï¼Œå®é™…ä¸Šå°±æ˜¯åœ¨å¯åŠ¨ systemd ğŸ˜‚

```shell
[    2.516258] Run /sbin/init as init process
[    3.992535] systemd[1]: systemd 237 running in system mode. (+PAM +AUDIT +SELINUX +IMA +APPARMOR +SMACK +SYSVINIT +UTMP +LIBCRYPTSETUP +GCRYPT +GNUTLS +ACL +XZ +LZ4 +SECCOMP +BLKID +ELFUTILS +KMOD -IDN2 +IDN -PCRE2 default-hierarchy=hybrid)
```

## ä¸»è§’ systemd

ä¸ºä»€ä¹ˆæ–‡ç« é¢˜åä¸º **Linux çš„å°ä¼™ä¼´ systemd** å‘ï¼Œå…¶å®å¹¿ä¹‰ä¸Šæ¥è®² Linux æ˜¯ä¼—å¤š Linux ç³»ç»Ÿå‘è¡Œç‰ˆçš„é›†åˆï¼Œä½†ä¸¥æ ¼æ¥è®² Linux ä»…ä»…æ˜¯ä¸€ä¸ª OS çš„ kernel è€Œå·²ï¼Œä»…ä»…æœ‰ä¸€ä¸ªå†…æ ¸æ˜¯æ— æ³•ç»„æˆä¸€ä¸ªç³»ç»Ÿçš„ï¼Œæ‰€ä»¥ Linux kernel è¿˜éœ€è¦ä»–çš„å‡ ä¸ªå…„å¼Ÿæ¯”å¦‚ GNU ã€ systemd ã€X Window ã€GNOME ã€ KDE ã€Xfce ç­‰ç­‰å…¶ä»–ç”¨æˆ·å±‚é¢çš„ç¨‹åºæ¥æ„å»ºå‡ºä¸€å¥—å®Œæ•´çš„æ“ä½œç³»ç»Ÿå‡ºæ¥ã€‚

è¿˜æœ‰å¦‚æœä½ è¦æ˜¯å½“ç€è‡ªç”±è½¯ä»¶åŸºé‡‘ä¼šä¸»å¸­ RMS [ç†æŸ¥å¾·Â·æ–¯æ‰˜æ›¼](https://zh.wikipedia.org/wiki/%E7%90%86%E6%9F%A5%E5%BE%B7%C2%B7%E6%96%AF%E6%89%98%E6%9B%BC) è¯´ Linux çš„è¯ï¼Œä»–ä¼šç»™ä½ å‘ç«å“¦ï¼Œä½ è¦è¯´ GNU/Linux æ‰è¡ŒğŸ˜‚ã€‚

å°† Debian å“²å­¦ä¸æ–¹æ³•è®ºï¼ŒGNU å·¥å…·é›†ã€Linux å†…æ ¸ï¼Œä»¥åŠå…¶ä»–é‡è¦çš„è‡ªç”±è½¯ä»¶ç»“åˆåœ¨ä¸€èµ·æ‰€æ„æˆçš„ç‹¬ç‰¹çš„è½¯ä»¶å‘è¡Œç‰ˆç§°ä¸º Debian GNU/Linuxã€‚å½“ä½ å°† Debian çš„å®‰è£…é•œåƒåˆ»å½•åˆ° U ç›˜ä¹‹åæ˜¾ç¤ºçš„åç§°å°±æ˜¯ `Debian GNU/Linux` ã€‚å…³äº GNU å’Œ Linux çš„æ•…äº‹å¯ä»¥å»çœ‹ä¸€å“ˆ [æ“ä½œç³»ç»Ÿé©å‘½](https://zh.wikipedia.org/zh-cn/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E9%9D%A9%E5%91%BD) çºªå½•ç‰‡ï¼Œä»¥åŠ RMS çš„è‡ªä¼ ã€Šè‹¥ä¸ºè‡ªç”±æ•…ï¼šè‡ªç”±è½¯ä»¶ä¹‹çˆ¶ç†æŸ¥å¾·Â·æ–¯æ‰˜æ›¼ä¼ ã€‹ä»¥åŠ Linus çš„è‡ªä¼ ã€Šåªæ˜¯ä¸ºäº†å¥½ç©å„¿ã€‹ã€‚

### systemd ç®€ä»‹

è®²å®Œäº† Linux ç³»ç»Ÿå¯åŠ¨çš„æµç¨‹ï¼Œæ¥ä¸‹æ¥å°±åˆ°äº†æœ¬æ–‡çš„ä¸»è§’ `systemd` ä¸Šåœºå•¦ã€‚å‰½çªƒä¸€æ®µ archlinux.org ä¸Šçš„æ–‡æ¡£æ¥ä»‹ç»ä¸€ä¸‹ systemd ã€‚ï¼ˆarchlinux çš„æ–‡æ¡£æ˜¯åšçš„æœ€å¥½çš„å“¦ï¼

> *systemd* æ˜¯ä¸€ä¸ª Linux ç³»ç»ŸåŸºç¡€ç»„ä»¶çš„é›†åˆï¼Œæä¾›äº†ä¸€ä¸ªç³»ç»Ÿå’ŒæœåŠ¡ç®¡ç†å™¨ï¼Œè¿è¡Œä¸º PID 1 å¹¶è´Ÿè´£å¯åŠ¨å…¶å®ƒç¨‹åºã€‚åŠŸèƒ½åŒ…æ‹¬ï¼š
>
> - æ”¯æŒå¹¶è¡ŒåŒ–ä»»åŠ¡ï¼›
> - åŒæ—¶é‡‡ç”¨ socket å¼ä¸ [D-Bus](https://wiki.archlinux.org/index.php/D-Bus_(ç®€ä½“ä¸­æ–‡)) æ€»çº¿å¼æ¿€æ´»æœåŠ¡ï¼›
> - æŒ‰éœ€å¯åŠ¨å®ˆæŠ¤è¿›ç¨‹ï¼ˆdaemonï¼‰ï¼›
> - åˆ©ç”¨ Linux çš„ [cgroups](https://wiki.archlinux.org/index.php/Cgroups) ç›‘è§†è¿›ç¨‹ï¼› # æœ¬æ–‡å¼€ç¯‡è®²åˆ°çš„ systemctl æ˜¾ç¤º CPU å’Œ  Mem ä¿¡æ¯å°±æ˜¯åŸºäºæ­¤å“¦ã€‚
> - æ”¯æŒå¿«ç…§å’Œç³»ç»Ÿæ¢å¤ï¼›
> - ç»´æŠ¤æŒ‚è½½ç‚¹å’Œè‡ªåŠ¨æŒ‚è½½ç‚¹ï¼›
> - å„æœåŠ¡é—´åŸºäºä¾èµ–å…³ç³»è¿›è¡Œç²¾å¯†æ§åˆ¶ã€‚
> - systemd* æ”¯æŒ SysV å’Œ LSB åˆå§‹è„šæœ¬ï¼Œå¯ä»¥æ›¿ä»£ sysvinitã€‚
> - é™¤æ­¤ä¹‹å¤–ï¼ŒåŠŸèƒ½è¿˜åŒ…æ‹¬æ—¥å¿—è¿›ç¨‹ã€æ§åˆ¶åŸºç¡€ç³»ç»Ÿé…ç½®ï¼Œç»´æŠ¤ç™»é™†ç”¨æˆ·åˆ—è¡¨ä»¥åŠç³»ç»Ÿè´¦æˆ·ã€è¿è¡Œæ—¶ç›®å½•å’Œè®¾ç½®ï¼Œå¯ä»¥è¿è¡Œå®¹å™¨å’Œè™šæ‹Ÿæœºï¼Œå¯ä»¥ç®€å•çš„ç®¡ç†ç½‘ç»œé…ç½®ã€ç½‘ç»œæ—¶é—´åŒæ­¥ã€æ—¥å¿—è½¬å‘å’Œåç§°è§£æç­‰ã€‚

è¿˜æœ‰ä¸€æ®µæ‘˜è‡ª [systemd.io](https://systemd.io/)

> systemd is a suite of basic building blocks for a Linux system. It provides a system and service manager that runs as PID 1 and starts the rest of the system.
>
> systemd provides aggressive parallelization capabilities, uses socket and D-Bus activation for starting services, offers on-demand starting of daemons, keeps track of processes using Linux control groups, maintains mount and automount points, and implements an elaborate transactional dependency-based service control logic. systemd supports SysV and LSB init scripts and works as a replacement for sysvinit.
>
> Other parts include a logging daemon, utilities to control basic system configuration like the hostname, date, locale, maintain a list of logged-in users and running containers and virtual machines, system accounts, runtime directories and settings, and daemons to manage simple network configuration, network time synchronization, log forwarding, and name resolution.

### systemd è®¾è®¡ç›®æ ‡

- æ”¹è¿›æ•ˆèƒ½ã€‚ä½¿ç”¨äºŒè¿›åˆ¶ä»£ç æ›¿æ¢æ¾æ•£çš„SYSVå¯åŠ¨è„šæœ¬ï¼Œå‡å°‘é¢‘ç¹çš„è¿›ç¨‹åˆ›å»ºï¼Œåº“åŠ è½½ï¼Œå†…æ ¸/ç”¨æˆ·åˆ‡æ¢ã€‚
- åˆ©ç”¨ Dbus è¿›ç¨‹é—´é€šè®¯ä¸ socket æ¿€æ´»æœºåˆ¶ï¼Œè§£å†³ä»»åŠ¡å¯åŠ¨æ—¶çš„ä¾èµ–é—®é¢˜ï¼Œå®ç°å¯åŠ¨å¹¶è¡ŒåŒ–ã€‚
- å®ç°ä»»åŠ¡ï¼ˆdaemonsï¼‰çš„ç²¾ç¡®æ§åˆ¶ã€‚ä½¿ç”¨å†…æ ¸çš„ cgroup æœºåˆ¶ï¼Œä¸ä¾èµ– pid æ¥è¿½è¸ªè¿›ç¨‹ï¼Œå³ä½¿æ˜¯ä¸¤æ¬¡ forkä¹‹åç”Ÿæˆçš„å®ˆæŠ¤è¿›ç¨‹ä¹Ÿä¸ä¼šè„±ç¦» systemd çš„æ§åˆ¶ã€‚
- ç»Ÿä¸€ä»»åŠ¡å®šä¹‰ã€‚ç”¨æˆ·ä¸éœ€è¦è‡ªè¡Œç¼–å†™ shell è„šæœ¬ï¼Œè€Œä»…ä¾æ® systemd åˆ¶å®šçš„ unit è§„åˆ™ã€‚

### systemd ä½“ç³»æ¶æ„

![](https://p.k8s.li/systemd_components-svg.png)

- æœ€åº•å±‚ï¼šsystemd å†…æ ¸å±‚é¢ä¾èµ– cgroupã€autofsã€kdbus
- ç¬¬äºŒå±‚ï¼šsystemd libraries æ˜¯ systemd ä¾èµ–åº“
- ç¬¬ä¸‰å±‚ï¼šsystemd Core æ˜¯ systemd è‡ªå·±çš„åº“
- ç¬¬å››å±‚ï¼šsystemd daemons ä»¥åŠ targets æ˜¯è‡ªå¸¦çš„ä¸€äº›åŸºæœ¬ unitã€targetï¼Œç±»ä¼¼äº sysvinit ä¸­è‡ªå¸¦çš„è„šæœ¬
- æœ€ä¸Šå±‚å°±æ˜¯å’Œ  systemd äº¤äº’çš„ä¸€äº›å·¥å…·

![](https://p.k8s.li/linux_kernel_unified_hierarchy_cgroups_and_systemd-svg.png)

### systemd unit

systemd å°†å„ç§ç³»ç»Ÿå¯åŠ¨å’Œè¿è¡Œç›¸å…³çš„å¯¹è±¡ï¼Œ è¡¨ç¤ºä¸ºå„ç§ä¸åŒç±»å‹çš„å•å…ƒ`unit`ï¼Œ å¹¶æä¾›äº† å¤„ç†ä¸åŒå•å…ƒä¹‹é—´ä¾èµ–å…³ç³»çš„èƒ½åŠ›ã€‚

|      type      |    name    | ä½œç”¨                                                         |
| :------------: | :--------: | :----------------------------------------------------------- |
|  Service unit  |  .service  | ç”¨äºå°è£…ä¸€ä¸ªåå°æœåŠ¡è¿›ç¨‹                                     |
|  Target unit   |  .target   | ç”¨äºå°†å¤šä¸ªå•å…ƒåœ¨é€»è¾‘ä¸Šç»„åˆåœ¨ä¸€èµ·ã€‚                           |
|  Device unit   |  .device   | ç”¨äºå®šä¹‰å†…æ ¸è¯†åˆ«çš„è®¾å¤‡ï¼Œåœ¨ sysfs(5) é‡Œé¢ä½œä¸º udev(7) è®¾å¤‡æ ‘å±•ç¤º |
|  Socket unit   |  .socket   | ç”¨äºæ ‡è¯†è¿›ç¨‹é—´é€šä¿¡ç”¨åˆ°çš„socketæ–‡ä»¶                           |
| Snapshot unit  | .snapshot  | ç®¡ç†ç³»ç»Ÿå¿«ç…§                                                 |
|   Swap unit    |   .swap    | ç”¨äºæ ‡è¯†swap æ–‡ä»¶æˆ–è®¾å¤‡                                      |
|   Mount unit   |   .mount   | ç”¨äºå°è£…ä¸€ä¸ªæ–‡ä»¶ç³»ç»ŸæŒ‚è½½ç‚¹(ä¹Ÿå‘åå…¼å®¹ä¼ ç»Ÿçš„ /etc/fstab æ–‡ä»¶) |
| Automount unit | .automount | ç”¨äºå°è£…ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿè‡ªåŠ¨æŒ‚è½½ç‚¹                               |
|   Path unit    |   .path    | ç”¨äºæ ¹æ®æ–‡ä»¶ç³»ç»Ÿä¸Šç‰¹å®šå¯¹è±¡çš„å˜åŒ–æ¥å¯åŠ¨å…¶ä»–æœåŠ¡ã€‚             |
|   Time unit    |   .timer   | ç”¨äºå°è£…ä¸€ä¸ªåŸºäºæ—¶é—´è§¦å‘çš„åŠ¨ä½œã€‚å–ä»£ä¼ ç»Ÿçš„ crond ç­‰ä»»åŠ¡è®¡åˆ’æœåŠ¡ |
|   Slice unit   |  *.slice   | ç”¨äºæ§åˆ¶ç‰¹å®š CGroup å†…æ‰€æœ‰è¿›ç¨‹çš„æ€»ä½“èµ„æºå ç”¨ã€‚               |

éœ€è¦æ³¨æ„çš„æ˜¯ systemd åªåœ¨å†…å­˜ä¸­åŠ è½½æœ€å°åŒ–çš„ä¸€ç»„å•å…ƒã€‚ åªæœ‰è‡³å°‘æ»¡è¶³ä¸‹åˆ—æ¡ä»¶ä¹‹ä¸€çš„å•å…ƒï¼Œæ‰ä¼šè¢«åŠ è½½åˆ°å†…å­˜ä¸­ï¼š

- å¤„äº æ´»åŠ¨(active)ã€å¯åŠ¨ä¸­(activating)ã€åœæ­¢ä¸­(deactivating)ã€å¤±è´¥(failed) çŠ¶æ€ä¹‹ä¸€(ä¹Ÿå°±æ˜¯åœæ­¢(inactive)ä¹‹å¤–çš„çŠ¶æ€)

- è‡³å°‘æœ‰ä¸€ä¸ªä½œä¸šæ­£åœ¨ä½œä¸šé˜Ÿåˆ—ä¸­

- è‡³å°‘æœ‰ä¸€ä¸ªå…¶ä»–å·²ç»åŠ è½½åˆ°å†…å­˜ä¸­çš„å•å…ƒä¾èµ–äºå®ƒ

- ä»ç„¶å æœ‰æŸäº›èµ„æº (ä¾‹å¦‚ä¸€ä¸ªå·²åœæ­¢çš„æœåŠ¡å•å…ƒçš„è¿›ç¨‹å¿½ç•¥äº†ç»ˆæ­¢è¯·æ±‚ï¼Œä»åœ¨é€—ç•™)

- è¢« D-Bus è°ƒç”¨ä»¥ç¨‹åºåŒ–çš„æ–¹å¼å›ºå®šåˆ°äº†å†…å­˜ä¸­

> åªè¦æœ‰éœ€è¦ï¼Œsystemd å°±ä¼šè‡ªåŠ¨ä»ç£ç›˜åŠ è½½æ‰€éœ€çš„å•å…ƒã€‚ å› æ­¤å®é™…ä¸Šç”¨æˆ·å¹¶ä¸èƒ½æ˜¾è€Œæ˜“è§çš„çœ‹åˆ°æŸä¸ªå•å…ƒæ˜¯å¦å·²è¢«åŠ è½½åˆ°å†…å­˜ã€‚ ä½¿ç”¨ **systemctl list-units --all** å‘½ä»¤å¯ä»¥æ˜¾ç¤ºå½“å‰å·²åŠ è½½åˆ°å†…å­˜ä¸­çš„æ‰€æœ‰å•å…ƒã€‚ ä¸æ»¡è¶³åŠ è½½æ¡ä»¶(è§ä¸Šæ–‡)çš„å•å…ƒä¼šè¢«ç«‹å³ä»å†…å­˜ä¸­å¸è½½ï¼Œå¹¶ä¸”å®ƒçš„è®°å¸æ•°æ®(accounting data)ä¹Ÿä¼šè¢«æ¸…ç©ºã€‚ ä¸è¿‡ï¼Œå› ä¸ºæ¯å½“ä¸€ä¸ªå•å…ƒå…³é—­æ—¶ï¼Œéƒ½ä¼šç”Ÿæˆä¸€æ¡æ—¥å¿—è®°å½•å£°æ˜è¯¥å•å…ƒæ‰€æ¶ˆè€—çš„èµ„æºï¼Œ æ‰€ä»¥è¿™äº›æ•°æ®é€šå¸¸ä¸ä¼šå½»åº•æ¶ˆå¤±ã€‚

### systemd unit é…ç½®æ–‡ä»¶

- åœ¨ CentOS/RedHat å‘è¡Œç‰ˆä¸­ `man systemd.unit`

```txt
       Table 1.  Load path when running in system mode (--system).
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚Path                    â”‚ Description                 â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚/etc/systemd/system     â”‚ Local configuration         â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚/run/systemd/system     â”‚ Runtime units               â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚/usr/lib/systemd/system â”‚ Units of installed packages â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- åœ¨ Ubuntu/Debian å‘è¡Œç‰ˆä¸­ `man systemd.unit`

```txt
       Table 1.  Load path when running in system mode (--system).
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚Path                â”‚ Description                 â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚/etc/systemd/system â”‚ Local configuration         â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚/run/systemd/system â”‚ Runtime units               â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚/lib/systemd/system â”‚ Units of installed packages â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ä¸åŒçš„å‘è¡Œç‰ˆ systemd unit çš„ path ä¸ä¸€æ ·å“¦ï¼Œä¸è¿‡ systemd çš„é…ç½®æ–‡ä»¶ä¸»è¦ä½äºä»¥ä¸‹ä¸‰ä¸ªç›®å½•ä¸­

- `/usr/lib/systemd/system` æˆ– `/lib/systemd` : ä½¿ç”¨åŒ…ç®¡ç†å™¨å®‰è£…çš„è½¯ä»¶çš„ systemd unit ä»¶å®é™…é…ç½®æ–‡ä»¶çš„å­˜æ”¾ä½ç½®

- `/run/systemd/system`ï¼šåœ¨è¿è¡Œæ—¶åˆ›å»ºçš„s ystemd unit æ–‡ä»¶ã€‚è¯¥ç›®å½•ä¼˜å…ˆäºå·²å®‰è£…æœåŠ¡å•å…ƒæ–‡ä»¶çš„ç›®å½•ã€‚

    `/etc/systemd/system`:  ä¼˜å…ˆçº§æœ€é«˜ï¼Œç”± systemctl å‘½ä»¤åˆ›å»ºçš„ systemd unit æ–‡ä»¶ä»¥åŠä¸ºæ‰©å±•æœåŠ¡è€Œæ·»åŠ çš„ unit æ–‡ä»¶éƒ½å°†å¯ç”¨ã€‚

åœ¨ä½¿ç”¨ yum/apt æˆ–å…¶ä»–åŒ…ç®¡ç†å™¨ï¼Œä»¥åŠ rpm/deb ç­‰è½¯ä»¶åŒ…å®‰è£…è½¯ä»¶çš„æ—¶å€™ï¼Œå¦‚æœè¯¥è½¯ä»¶æ”¯æŒ systemd ç®¡ç†çš„è¯ï¼Œå°±ä¼šè‡ªåŠ¨åœ¨`/usr/lib/systemd/system`ç›®å½•æ·»åŠ ä¸€ä¸ªé…ç½®æ–‡ä»¶ã€‚å¯ä»¥ç”¨è¿‡  systemctl cat name æ¥æŸ¥çœ‹è¯¥è½¯ä»¶çš„  systemd å•å…ƒæ–‡ä»¶ï¼Œæ¯”å¦‚æŸ¥çœ‹ä¸€ä¸‹ nginx çš„ `nginx.service` æ–‡ä»¶

```shell
â•­â”€root@sg-02 ~
â•°â”€# systemctl cat nginx                                                                                         1 â†µ
# /lib/systemd/system/nginx.service
# Stop dance for nginx
# =======================
#
# ExecStop sends SIGSTOP (graceful stop) to the nginx process.
# If, after 5s (--retry QUIT/5) nginx is still running, systemd takes control
# and sends SIGTERM (fast shutdown) to the main process.
# After another 5s (TimeoutStopSec=5), and if nginx is alive, systemd sends
# SIGKILL to all the remaining processes in the process group (KillMode=mixed).
#
# nginx signals reference doc:
# http://nginx.org/en/docs/control.html
#
[Unit]
Description=A high performance web server and a reverse proxy server
Documentation=man:nginx(8)
After=network.target

[Service]
Type=forking
PIDFile=/run/nginx.pid
ExecStartPre=/usr/sbin/nginx -t -q -g 'daemon on; master_process on;'
ExecStart=/usr/sbin/nginx -g 'daemon on; master_process on;'
ExecReload=/usr/sbin/nginx -g 'daemon on; master_process on;' -s reload
ExecStop=-/sbin/start-stop-daemon --quiet --stop --retry QUIT/5 --pidfile /run/nginx.pid
TimeoutStopSec=5
KillMode=mixed

[Install]
```

å¦‚æœè½¯ä»¶æ²¡æœ‰è‡ªå¸¦ systemd é…ç½®æ–‡ä»¶çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±æ“ä¸€ä¸ªé…ç½®æ–‡ä»¶å‡ºæ¥ï¼Œå¹¶å¤åˆ¶åˆ°ç›¸åº”çš„ç›®å½•ä¸‹å³å¯ã€‚æ¯”æˆ‘æˆ‘ä»¬çš„ [Webp Server Go](https://github.com/webp-sh/webp_server_go) çš„ `webps.service`

```ini
[Unit]
Description=WebP Server Go
Documentation=https://github.com/webp-sh/webp_server_go
After=nginx.target

[Service]
Type=simple
StandardError=journal
WorkingDirectory=/opt/webps
ExecStart=/opt/webps/webp-server --config /opt/webps/config.json
Restart=always
RestartSec=3s

[Install]
WantedBy=multi-user.target
```

å…³äº systemd çš„å•å…ƒé…ç½®æ–‡ä»¶å¦‚ä½•ä¹¦å†™ï¼Œå› ä¸ºæ ¹æ®ä¸åŒçš„å•å…ƒç±»å‹åŒ…å«çš„é…ç½®é¡¹å®åœ¨æ˜¯å·¨å¤šã€‚ä¸æ˜¯ä¸‰è¨€ä¸¤è¯­å°±èƒ½è®²æ¸…çš„ï¼Œæ‰€ä»¥å¤§å®¶è¿˜æ˜¯å‚è€ƒä¸€ä¸‹ systemd çš„å®˜æ–¹æ–‡æ¡£/ç¤¾åŒºç¿»è¯‘æ–‡æ¡£ã€‚æ¯”å¦‚ [systemd (ç®€ä½“ä¸­æ–‡)](http://www.jinbuguo.com/systemd/systemd.index.html)ã€‚

### é“¾æ¥æ–‡ä»¶

å½“æˆ‘ä»¬ä½¿ç”¨ reboot ã€poweroff ã€shutdown ç­‰å‘½ä»¤çš„æ—¶å€™ï¼Œå…¶å®å¹¶ä¸æ˜¯æ‰§è¡Œè¯¥å‘½ä»¤æœ¬èº«ï¼ŒèƒŒåæ˜¯è°ƒç”¨çš„ systemctl å‘½ä»¤ã€‚systemctl å‘½ä»¤ä¼šå°† reboot è¿™äº›å‘½ä»¤ä½œä¸º $1 å‚æ•°ä¼ é€’è¿›å»ã€‚æ‰€ä»¥æ‰§è¡Œ reboot å’Œ systemctl reboot æœ¬è´¨ä¸Šæ˜¯ä¸€æ ·çš„ã€‚

```shell
â•­â”€root@gitlab /sbin
â•°â”€# ls -alh /usr/bin /sbin /bin /usr/local/bin  | grep systemctl
-rwxr-xr-x  1 root root 179K Feb  5 01:07 systemctl
lrwxrwxrwx  1 root root      14 Feb  5 01:07 halt -> /bin/systemctl
lrwxrwxrwx  1 root root      14 Feb  5 01:07 poweroff -> /bin/systemctl
lrwxrwxrwx  1 root root      14 Feb  5 01:07 reboot -> /bin/systemctl
lrwxrwxrwx  1 root root      14 Feb  5 01:07 runlevel -> /bin/systemctl
lrwxrwxrwx  1 root root      14 Feb  5 01:07 shutdown -> /bin/systemctl
lrwxrwxrwx  1 root root      14 Feb  5 01:07 telinit -> /bin/systemctl
```

è¿˜æœ‰å‰æ–‡æåˆ°çš„æœ‰ä¸€ç‚¹å°±æ˜¯ç»å¤§å¤šæ•°ä½¿ç”¨ systemd çš„å‘è¡Œç‰ˆéƒ½è®¾ç½®äº†ä¸€ä¸ªè½¯è¿æ¥ï¼Œç”± `/sbin/init -> /lib/systemd/systemd`ã€‚å¦å¤–åœ¨ `/etc/systemd` ä¸‹ä¹Ÿæœ‰å¾ˆå¤šé“¾æ¥æ–‡ä»¶ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥å»åˆ†æä¸€ä¸‹ã€‚

### systemd å¯åŠ¨æµç¨‹

å›åˆ° Linux å¯åŠ¨æµç¨‹ï¼Œå½“å†…æ ¸åŠ è½½åˆ°å†…å­˜ä¸­åå¼€å§‹æ‰§è¡Œ systemd ã€‚æ ¹æ® dmesg çš„æ—¥å¿—æˆ‘ä»¬å¯ä»¥äº†è§£åˆ° systemd å¯åŠ¨åæ‰§è¡Œäº†å“ªä¸€äº›æ“ä½œã€‚

```verilog
[    2.516258] Run /sbin/init as init process
[    3.992535] systemd[1]: systemd 237 running in system mode. (+PAM +AUDIT +SELINUX +IMA +APPARMOR +SMACK +SYSVINIT +UTMP +LIBCRYPTSETUP +GCRYPT +GNUTLS +ACL +XZ +LZ4 +SECCOMP +BLKID +ELFUTILS +KMOD -IDN2 +IDN -PCRE2 default-hierarchy=hybrid)
[    4.002297] systemd[1]: Detected virtualization kvm.
[    4.004593] systemd[1]: Detected architecture x86-64.
[    4.031531] systemd[1]: Set hostname to <blog>.
[    5.343604] systemd[1]: Reached target Swap.
[    5.355156] systemd[1]: Started Dispatch Password Requests to Console Directory Watch.
[    5.367360] systemd[1]: Created slice User and Session Slice.
[    5.379321] systemd[1]: Set up automount Arbitrary Executable File Formats File System Automount Point.
[    5.395189] systemd[1]: Started Forward Password Requests to Wall Directory Watch.
[    5.411078] systemd[1]: Reached target Local Encrypted Volumes.
[    5.644759] EXT4-fs (sda1): re-mounted. Opts: (null)
[    5.702603] RPC: Registered named UNIX socket transport module.
[    5.704115] RPC: Registered udp transport module.
[    5.705318] RPC: Registered tcp transport module.
[    5.706573] RPC: Registered tcp NFSv4.1 backchannel transport module.
[    5.825727] Loading iSCSI transport class v2.0-870.
[    5.912079] iscsi: registered transport (tcp)
[    5.942499] systemd-journald[196]: Received request to flush runtime journal from PID 1
[    5.973269] systemd-journald[196]: File /var/log/journal/7bc72ce3e0aa559e38159aa4fa0547f9/system.journal corrupted or uncleanly shut down, renaming and replacing.
```

> ä¸‹é¢çš„å›¾è¡¨è§£é‡Šäº† è¿™äº›å…·æœ‰ç‰¹å®šå«ä¹‰çš„ target å•å…ƒä¹‹é—´çš„ä¾èµ–å…³ç³» ä»¥åŠå„è‡ªåœ¨å¯åŠ¨æµç¨‹ä¸­çš„ä½ç½®ã€‚å›¾ä¸­çš„ç®­å¤´è¡¨ç¤ºäº†å•å…ƒä¹‹é—´çš„ä¾èµ–å…³ç³»ä¸å…ˆåé¡ºåºï¼Œ æ•´ä¸ªå›¾è¡¨æŒ‰ç…§è‡ªä¸Šè€Œä¸‹çš„æ—¶é—´é¡ºåºæ‰§è¡Œã€‚

```verilog
local-fs-pre.target
            |
            v
   (various mounts and   (various swap   (various cryptsetup
    fsck services...)     devices...)        devices...)       (various low-level   (various low-level
            |                  |                  |             services: udevd,     API VFS mounts:
            v                  v                  v             tmpfiles, random     mqueue, configfs,
     local-fs.target      swap.target     cryptsetup.target    seed, sysctl, ...)      debugfs, ...)
            |                  |                  |                    |                    |
            \__________________|_________________ | `_______________` |____________________/
                                                 \|/
                                                  v
                                           sysinit.target
                                                  |
             `________________________________` /|\________________________________________
            /                  |                  |                    |                    \
            |                  |                  |                    |                    |
            v                  v                  |                    v                    v
        (various           (various               |                (various          rescue.service
       timers...)          paths...)              |               sockets...)               |
            |                  |                  |                    |                    v
            v                  v                  |                    v             *rescue.target
      timers.target      paths.target             |             sockets.target
            |                  |                  |                    |
            v                  \_________________ | `_______________` /
                                                 \|/
                                                  v
                                            basic.target
                                                  |
             `________________________________` /|                                 emergency.service
            /                  |                  |                                         |
            |                  |                  |                                         v
            v                  v                  v                                *emergency.target
        display-        (various system    (various system
    manager.service         services           services)
            |             required for            |
            |            graphical UIs)           v
            |                  |          *multi-user.target
            |                  |                  |
            \_________________ | `_____________` /
                              \|/
                               v
                  *graphical.target

```

- systemd æ‰§è¡Œçš„ç¬¬ä¸€ä¸ªç›®æ ‡æ˜¯ **default.target**ã€‚ä½†å®é™…ä¸Š default.target æ˜¯æŒ‡å‘ **graphical.target** çš„è½¯é“¾æ¥ã€‚Graphical.target çš„å®é™…ä½ç½®æ˜¯`/usr/lib/systemd/system/graphical.target`ã€‚

```ini
â•­â”€root@ ~
â•°â”€# cat /usr/lib/systemd/system/graphical.target
#  This file is part of systemd.
#
#  systemd is free software; you can redistribute it and/or modify it
#  under the terms of the GNU Lesser General Public License as published by
#  the Free Software Foundation; either version 2.1 of the License, or
#  (at your option) any later version.

[Unit]
Description=Graphical Interface
Documentation=man:systemd.special(7)
Requires=multi-user.target
Wants=display-manager.service
Conflicts=rescue.service rescue.target
After=multi-user.target rescue.service rescue.target display-manager.service
AllowIsolate=yes
```

- åœ¨**default.target**è¿™ä¸ªé˜¶æ®µï¼Œä¼šå¯åŠ¨**multi-user.target**è€Œè¿™ä¸ª target å°†è‡ªå·±çš„å­å•å…ƒæ”¾åœ¨ç›®å½•`/etc/systemd/system/multi-user.target.wants`é‡Œã€‚è¿™ä¸ª target ä¸ºå¤šç”¨æˆ·æ”¯æŒè®¾å®šç³»ç»Ÿç¯å¢ƒã€‚é rootç”¨æˆ·ä¼šåœ¨è¿™ä¸ªé˜¶æ®µçš„å¼•å¯¼è¿‡ç¨‹ä¸­å¯ç”¨ã€‚é˜²ç«å¢™ç›¸å…³çš„æœåŠ¡ä¹Ÿä¼šåœ¨è¿™ä¸ªé˜¶æ®µå¯åŠ¨ã€‚**multi-user.target**ä¼šå°†æ§åˆ¶æƒäº¤ç»™å¦ä¸€å±‚**basic.target**ã€‚

```ini
â•­â”€root@docker-230 ~
â•°â”€# cat /usr/lib/systemd/system/multi-user.target
#  This file is part of systemd.
#
#  systemd is free software; you can redistribute it and/or modify it
#  under the terms of the GNU Lesser General Public License as published by
#  the Free Software Foundation; either version 2.1 of the License, or
#  (at your option) any later version.

[Unit]
Description=Multi-User System
Documentation=man:systemd.special(7)
Requires=basic.target
Conflicts=rescue.service rescue.target
After=basic.target rescue.service rescue.target
AllowIsolate=yes
```

- **basic.target**å•å…ƒç”¨äºå¯åŠ¨æ™®é€šæœåŠ¡ç‰¹åˆ«æ˜¯å›¾å½¢ç®¡ç†æœåŠ¡ã€‚å®ƒé€šè¿‡`/etc/systemd/system/basic.target.wants`ç›®å½•æ¥å†³å®šå“ªäº›æœåŠ¡ä¼šè¢«å¯åŠ¨ï¼Œ**basic.target** ä¹‹åå°†æ§åˆ¶æƒäº¤ç»™ **sysinit.target**.

```shell
â•­â”€root@docker-230 ~
â•°â”€# tree /etc/systemd/system/multi-user.target.wants
/etc/systemd/system/multi-user.target.wants
â”œâ”€â”€ auditd.service -> /usr/lib/systemd/system/auditd.service
â”œâ”€â”€ chronyd.service -> /usr/lib/systemd/system/chronyd.service
â”œâ”€â”€ crond.service -> /usr/lib/systemd/system/crond.service
â”œâ”€â”€ docker.service -> /usr/lib/systemd/system/docker.service
â”œâ”€â”€ firewalld.service -> /usr/lib/systemd/system/firewalld.service
â”œâ”€â”€ gitlab-runsvdir.service -> /usr/lib/systemd/system/gitlab-runsvdir.service
â”œâ”€â”€ irqbalance.service -> /usr/lib/systemd/system/irqbalance.service
â”œâ”€â”€ kdump.service -> /usr/lib/systemd/system/kdump.service
â”œâ”€â”€ NetworkManager.service -> /usr/lib/systemd/system/NetworkManager.service
â”œâ”€â”€ remote-fs.target -> /usr/lib/systemd/system/remote-fs.target
â”œâ”€â”€ rhel-configure.service -> /usr/lib/systemd/system/rhel-configure.service
â”œâ”€â”€ rsyslog.service -> /usr/lib/systemd/system/rsyslog.service
â”œâ”€â”€ sshd.service -> /usr/lib/systemd/system/sshd.service
â””â”€â”€ tuned.service -> /usr/lib/systemd/system/tuned.service
```

- **sysinit.target**ä¼šå¯åŠ¨é‡è¦çš„ç³»ç»ŸæœåŠ¡ä¾‹å¦‚ç³»ç»ŸæŒ‚è½½ï¼Œå†…å­˜äº¤æ¢ç©ºé—´å’Œè®¾å¤‡ï¼Œå†…æ ¸è¡¥å……é€‰é¡¹ç­‰ç­‰ã€‚sysinit.target åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ä¼šä¼ é€’ç»™**local-fs.target**ã€‚

```bash
â•­â”€root@docker-230 ~
â•°â”€# tree /etc/systemd/system/basic.target.wants
/etc/systemd/system/basic.target.wants
â”œâ”€â”€ microcode.service -> /usr/lib/systemd/system/microcode.service
â””â”€â”€ rhel-dmesg.service -> /usr/lib/systemd/system/rhel-dmesg.service

0 directories, 2 files
```

- `local-fs.target`ï¼Œè¿™ä¸ª target å•å…ƒä¸ä¼šå¯åŠ¨ç”¨æˆ·ç›¸å…³çš„æœåŠ¡ï¼Œå®ƒåªå¤„ç†åº•å±‚æ ¸å¿ƒæœåŠ¡ã€‚è¿™ä¸ª target ä¼šæ ¹æ® /etc/fstab å’Œ /etc/inittab æ¥æ‰§è¡Œç›¸å…³æ“ä½œã€‚

```ini
â•­â”€root@docker-230 ~
â•°â”€# cat /usr/lib/systemd/system/sysinit.target
#  This file is part of systemd.
#
#  systemd is free software; you can redistribute it and/or modify it
#  under the terms of the GNU Lesser General Public License as published by
#  the Free Software Foundation; either version 2.1 of the License, or
#  (at your option) any later version.

[Unit]
Description=System Initialization
Documentation=man:systemd.special(7)
Conflicts=emergency.service emergency.target
Wants=local-fs.target swap.target
After=local-fs.target swap.target emergency.service emergency.target
```

### è¿›ç¨‹æ ‘

æˆ‘ä»¬ä½¿ç”¨ pstree å‘½ä»¤æ¥çœ‹ä¸€å“ˆè¿›ç¨‹æ ‘çš„çŠ¶æ€ï¼Œç”¨æˆ·ç©ºé—´çš„è¿›ç¨‹éƒ½æŒ‚åœ¨  PID ä¸º 1 çš„ systemd ä¸‹ã€‚ç”± systemd æ¥ç®¡ç†è¿›ç¨‹ä¼˜ç‚¹å¤šå¤š ğŸ˜‚

```shell
â•­â”€root@sg-02 ~
â•°â”€# pstree -p
systemd(1)â”€â”¬â”€accounts-daemon(661)â”€â”¬â”€{accounts-daemon}(689)
           â”‚                      â””â”€{accounts-daemon}(729)
           â”œâ”€agetty(971)
           â”œâ”€agetty(992)
           â”œâ”€aria2c(1010)
           â”œâ”€atd(653)
           â”œâ”€containerd(2915)â”€â”¬â”€{containerd}(2928)
           â”‚                  â”œâ”€{containerd}(2929)
           â”‚                  â”œâ”€{containerd}(2930)
           â”‚                  â”œâ”€{containerd}(2934)
           â”‚                  â”œâ”€{containerd}(2935)
           â”‚                  â”œâ”€{containerd}(2950)
           â”‚                  â”œâ”€{containerd}(2951)
           â”‚                  â”œâ”€{containerd}(2978)
           â”‚                  â”œâ”€{containerd}(5360)
           â”‚                  â””â”€{containerd}(8299)
           â”œâ”€cron(639)â”€â”€â”€cron(20506)â”€â”€â”€sh(20507)â”€â”€â”€monitor.sh(20509)â”€â”€â”€ffmpeg(20514)
           â”œâ”€dbus-daemon(664)
           â”œâ”€dockerd(17771)â”€â”¬â”€{dockerd}(17783)
           â”‚                â”œâ”€{dockerd}(17784)
           â”‚                â”œâ”€{dockerd}(17785)
           â”‚                â”œâ”€{dockerd}(17791)
           â”‚                â”œâ”€{dockerd}(17793)
           â”‚                â”œâ”€{dockerd}(17800)
           â”‚                â”œâ”€{dockerd}(17803)
           â”‚                â”œâ”€{dockerd}(3030)
           â”‚                â””â”€{dockerd}(3031)
           â”œâ”€fail2ban-server(755)â”€â”¬â”€{fail2ban-server}(1059)
           â”‚                      â””â”€{fail2ban-server}(1060)
           â”œâ”€iscsid(896)
           â”œâ”€iscsid(897)
           â”œâ”€lvmetad(392)
           â”œâ”€networkd-dispat(622)â”€â”€â”€{networkd-dispat}(982)
           â”œâ”€nginx(3305)â”€â”€â”€nginx(17700)
           â”œâ”€php-fpm7.2(7497)â”€â”¬â”€php-fpm7.2(1295)
           â”‚                  â”œâ”€php-fpm7.2(1296)
           â”‚                  â””â”€php-fpm7.2(5611)
           â”œâ”€polkitd(808)â”€â”¬â”€{polkitd}(820)
           â”‚              â””â”€{polkitd}(822)
           â”œâ”€rngd(981)
           â”œâ”€rpcbind(7125)
           â”œâ”€rsyslogd(11567)â”€â”¬â”€{rsyslogd}(11598)
           â”‚                 â”œâ”€{rsyslogd}(11599)
           â”‚                 â””â”€{rsyslogd}(11600)
           â”œâ”€ss-server(17126)â”€â”€â”€obfs-server(17138)
             â”œâ”€sshd(5357)â”€â”¬â”€sshd(15490)â”€â”€â”€sshd(15598)â”€â”€â”€zsh(15619)â”€â”€â”€pstree(20539)
           â”‚            â”œâ”€sshd(20413)â”€â”€â”€sshd(20414)
           â”‚            â””â”€sshd(20517)
           â”œâ”€systemd(5715)â”€â”€â”€(sd-pam)(5718)
           â”œâ”€systemd-journal(12866)
           â”œâ”€systemd-logind(652)
           â”œâ”€systemd-network(12827)
           â”œâ”€systemd-resolve(12839)
           â”œâ”€systemd-timesyn(12852)â”€â”€â”€{systemd-timesyn}(12861)
           â””â”€systemd-udevd(8171)
```

## ç®¡ç† systemd

è®²å®Œäº† systemd çš„åŸºç¡€çŸ¥è¯†ï¼Œæ¥ä¸‹æ¥å°±å¼€å§‹åŠ¨æ‰‹å®è·µï¼Œæ§åˆ¶ systemd çš„ä¸»è¦å‘½ä»¤ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§ï¼š

- systemctl å‘½ä»¤æ§åˆ¶ `systemd` çš„ç®¡ç†ç³»ç»Ÿå’ŒæœåŠ¡çš„å‘½ä»¤è¡Œå·¥å…·
- systemsdm å‘½ä»¤æ§åˆ¶ `systemd` çš„ç®¡ç†å’ŒæœåŠ¡çš„å›¾å½¢åŒ–å·¥å…·
- journalctl å‘½ä»¤æŸ¥è©¢ `systemd` æ—¥å¿—ç³»ç»Ÿ
- loginctl å‘½ä»¤æ§åˆ¶ `systemd` ç™»å…¥ç®¡ç†å™¨
- systemd-analyze åˆ†æç³»ç»Ÿå¯åŠ¨æ•ˆèƒ½ï¼ˆç±»ä¼¼å¼€æœºæ—¶é—´ï¼Ÿ

### systemctl åŸºæœ¬ç”¨æ³•

#### å¯åŠ¨/é‡å¯/åœæ­¢æœåŠ¡

- `systemctl start NAME`
- `systemctl restart NAME`
- `systemctl stop NAME`

#### æŸ¥çœ‹æœåŠ¡çŠ¶æ€

å°±å¦‚æ–‡ç« å¼€å¤´æ‰€æåˆ°çš„ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯æœ€ä¸‹é¢é‚£ç§å¸¦æ—¶é—´æˆ³çš„æ˜¯è¾“å‡ºçš„æ—¥å¿—

- `systemctl status NAME`

```shell
â•­â”€root@blog /home/ubuntu
â•°â”€# systemctl status webps                                                                                    130 â†µ
â— webps.service - WebP Server
   Loaded: loaded (/opt/webps/webps.service; enabled; vendor preset: enabled)
   Active: active (running) since Wed 2020-03-18 13:58:00 UTC; 22h ago
     Docs: https://github.com/n0vad3v/webp_server_go
 Main PID: 5732 (webp-server)
    Tasks: 52 (limit: 684)
   Memory: 185.2M
      CPU: 1min 30.092s
   CGroup: /system.slice/webps.service
           â””â”€5732 /opt/webps/webp-server --config /opt/webps/config.json

Mar 19 05:23:20 blog webp-server[5732]: Save to exhaust/img/20200109192923891.png.1584538399.webp ok
```

#### åˆ—å‡ºæ‰€æœ‰å•å…ƒï¼š

- `systemctl list-unit-files`

```bash
â•­â”€root@docker-230 ~
â•°â”€# systemctl list-unit-files
UNIT FILE                                     STATE
proc-sys-fs-binfmt_misc.automount             static
dev-hugepages.mount                           static
dev-mqueue.mount                              static
```

#### åˆ—å‡ºæ¿€æ´»çš„å•å…ƒ

- `systemctl list-units` ç­‰åŒäº `systemctl`

```shell
â•­â”€root@docker-230 ~
â•°â”€# systemctl list-units                                                                                      127 â†µ
  UNIT                                         LOAD   ACTIVE SUB       DESCRIPTION
  proc-sys-fs-binfmt_misc.automount            loaded active waiting   Arbitrary Executable File Formats File System
  sys-devices-pci0000:00-0000:00:15.0-0000:03:00.0-host2-target2:0:0-2:0:0:0-block-sda-sda1.device loaded active plu
  sys-devices-pci0000:00-0000:00:15.0-0000:03:00.0-host2-target2:0:0-2:0:0:0-block-sda-sda2.device loaded active plu
```

#### é‡æ–°è½½å…¥ systemdï¼Œæ‰«ææ–°çš„æˆ–æœ‰å˜åŠ¨çš„å•å…ƒï¼š

å½“å‘ systemd çš„ç›®å½•ä¸­æ·»åŠ æ˜¾å¾— unit æ–‡ä»¶åéœ€è¦ reload ä¸€ä¸‹æ‰èƒ½ç”Ÿæ•ˆ

- `systemctl daemon-reload`

#### æŸ¥è¯¢æœåŠ¡æ˜¯å¦å¼€æœºå¯åŠ¨

- `systemctl is-enabled crond`

#### è®¾ç½®/å–æ¶ˆæœåŠ¡å¼€æœºè‡ªå¯

- `systemctl enable NAME`
- `systemctl disable NAME`

#### è¿œç¨‹æ§åˆ¶å…¶ä»–æœåŠ¡å™¨çš„ systemd

 `systemctl` å‚æ•°ä¸­æ·»åŠ  `-H <ç”¨æˆ·å>@<ä¸»æœºå>` å¯ä»¥å®ç°å¯¹å…¶ä»–æœºå™¨çš„è¿œç¨‹æ§åˆ¶ï¼Œè¯¥åŠŸèƒ½ä½¿ç”¨ [SSH](https://wiki.archlinux.org/index.php/SSH_(ç®€ä½“ä¸­æ–‡)) è¿æ¥ã€‚

```shell
â•­â”€root@blog /home/ubuntu
â•°â”€# systemctl status nginx -H sg2
â— nginx.service - A high performance web server and a reverse proxy server
   Loaded: loaded (/lib/systemd/system/nginx.service; enabled; vendor preset: enabled)
   Active: active (running) since Mon 2020-02-17 08:41:11 UTC; 1 months 0 days ago
     Docs: man:nginx(8)
 Main PID: 3305
    Tasks: 2 (limit: 1152)
   CGroup: /system.slice/nginx.service
           â”œâ”€ 3305 nginx: master process /usr/sbin/nginx -g daemon on; master_process on;
           â””â”€17700 nginx: worker process
```

#### ä½¿ç”¨systemctlå‘½ä»¤æ€æ­»æœåŠ¡

- `systemctl kill NAME`

### journal

systemd çš„ç¬¬äºŒä¸ªä¸»è¦éƒ¨åˆ†æ˜¯ journal æ—¥å¿—ç³»ç»Ÿï¼Œç±»ä¼¼äº syslog ä½†ä¹Ÿæœ‰äº›æ˜¾è‘—åŒºåˆ«ã€‚å¦‚æœä½ å–œæ¬¢ç”¨ `sed ã€grep ã€awk` ä¸‰å‰‘å®¢æ¥å¤„ç†æ—¥å¿—ï¼Œé‚£ä¹ˆå½“ä½ é¢å¯¹ journal æ—¥å¿—ç³»ç»Ÿçš„æ—¶å€™ä½ å°±å‡†å¤‡**æ€æ¡Œå„¿**å§ï¼å› ä¸ºè¿™æ˜¯ä¸ªäºŒè¿›åˆ¶æ—¥å¿—ï¼Œæ— æ³•ä½¿ç”¨å¸¸è§„çš„å‘½ä»¤è¡Œæ–‡æœ¬å¤„ç†å·¥å…·æ¥è§£æå®ƒğŸ˜‚

### systemd-analyze

```bash
â•­â”€root@docker-230 ~
â•°â”€# systemd-analyze
Startup finished in 489ms (kernel) + 1.547s (initrd) + 10.333s (userspace) = 12.369s
```

## æ¨è/å‚è€ƒ

### æºç 

- [github.com/systemd/systemd](https://github.com/systemd/systemd)
- [systemd.io](https://systemd.io/)

### æ–‡æ¡£

- [systemd.exec ä¸­æ–‡æ‰‹å†Œ](http://www.jinbuguo.com/systemd/systemd.exec.html)

- [systemd (ç®€ä½“ä¸­æ–‡)](https://wiki.archlinux.org/index.php/systemd_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87))

- [wiki.debian.org/systemd](https://wiki.debian.org/systemd)

- [ç¬¬ 3 ç«  ç³»çµ±åˆå§‹åŒ–](https://www.debian.org/doc/manuals/debian-reference/ch03.zh-tw.html)

- [OpenWrt â€“ operating system architecture](https://openwrt.org/docs/techref/architecture)

- [bootup - ç³»ç»Ÿå¯åŠ¨æµç¨‹](http://manpages.ubuntu.com/manpages/cosmic/zh_CN/man7/bootup.7.html)

- [CHAPTER 10. MANAGING SERVICES WITH SYSTEMD](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/system_administrators_guide/chap-managing_services_with_systemd)

### åšå®¢

- [LINUX PID 1 å’Œ SYSTEMD](https://coolshell.cn/articles/17998.html) è€—å­çš„åšå®¢ï¼Œå¿…é¡»å¢™è£‚æ¨èé˜…è¯»å“ˆï¼Œå…¶ä»–çš„å¯ä»¥ä¸è¯»ï¼Œä½†è¿™ä¸€ç¯‡åšå®¢å¿…é¡»è¦è¯»å“¦ ï¼šï¼‰

- [systemdçš„ä¸€äº›æ€»ç»“](https://lp007819.wordpress.com/2015/01/11/systemd%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%BB%E7%BB%93/)

- [èµ°è¿›Linuxä¹‹systemdå¯åŠ¨è¿‡ç¨‹](https://linux.cn/article-5457-1.html)

- [13.3 Centos7 Systemd å¯åŠ¨æµç¨‹](https://hotttao.github.io/2018/08/03/linux_mt/14-Linux%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97%E7%AE%A1%E7%90%86/CentOS7-Systemd%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/)

- [Torvalds says he has no strong opinions on systemd](https://www.itwire.com/business-it-news/open-source/65402-torvalds-says-he-has-no-strong-opinions-on-systemd)

- [Rethinking PID 1](http://0pointer.de/blog/projects/systemd.html)

- [The Biggest Myths](http://0pointer.de/blog/projects/the-biggest-myths.html)

- [Linux æ€ä¹ˆè®©ç¨‹åºæŒç»­è¿è¡Œï¼šç®€å•è¯´è¯´å‡ ç§å¥½ç©çš„åŠæ³•](https://www.bennythink.com/linux-keep-running.html)

- [systemd â€“ systemctl ä¸æ˜¾ç¤ºå†…å­˜ CPU ä¿¡æ¯](https://www.bennythink.com/systemd-accounting.html)

- [systemd journal ä»‹ç»](https://lp007819.wordpress.com/2015/01/17/systemd-journal-%e4%bb%8b%e7%bb%8d/)

- [ä½¿ç”¨journalctlæŸ¥çœ‹systemdæ—¥å¿—](http://blog.lujun9972.win/blog/2018/08/08/%E4%BD%BF%E7%94%A8journalctl%E6%9F%A5%E7%9C%8Bsystemd%E6%97%A5%E5%BF%97/index.html)

- [å¦‚ä½•é˜²æ­¢æ„å¤–é‡å¯Linux(åŸºäºsystemd)](http://blog.lujun9972.win/blog/2019/11/30/%E5%A6%82%E4%BD%95%E9%98%B2%E6%AD%A2%E6%84%8F%E5%A4%96%E9%87%8D%E5%90%AFlinux(%E5%9F%BA%E4%BA%8Esystemd)/index.html)
