---
title: é•œåƒæ¬è¿å·¥ skopeo
date: 2021-07-11
updated: 2021-07-11
slug:
categories: æŠ€æœ¯
tag:
  - é•œåƒ
  - skopeo
  - registry
copyright: true
comment: true
---

## æ¬ç –å·¥å…·

ä½œä¸ºå…¬å¸å†…éƒ¨ PaaS toB äº§å“çš„æ‰“åŒ…å‘å¸ƒäººå‘˜ï¼Œå®¹å™¨é•œåƒå¯¹æˆ‘ä»¬æ‰“å·¥äººè€Œè¨€å°±åƒæ˜¯å·¥åœ°ä¸Šçš„ç –å¤´ ğŸ§±ï¼Œè€Œæˆ‘çš„ä¸€éƒ¨åˆ†å·¥ä½œå°±æ˜¯å°†è¿™äº›ç –å¤´åœ¨å„ä¸ªä»“åº“ä¹‹é—´æ¬æ¥æ¬å»ï¼Œæœ€ç»ˆå°†è¿™äº›ç –å¤´æ‰“åŒ…æ”¾åœ¨äº§å“çš„å®‰è£…åŒ…ä¸­ï¼Œå½¢æˆä¸€ä¸ªå®Œæ•´çš„ PaaS äº§å“å®‰è£…åŒ…ã€‚

è€Œé€‰æ‹©ä¸€ä¸ªå¥½çš„æ¬ç –å·¥å…·èƒ½èŠ‚çœæˆ‘ä»¬å¤§é‡çš„äººåŠ›å’Œ CPU ç®—åŠ›ï¼Œåœ¨æ—¥å¸¸å¼€å‘å·¥ä½œä¸­æˆ‘ä»¬ä¹Ÿå¸¸å¸¸ä¼šä½¿ç”¨ docker push å’Œ docker pull æ¥æ¨æ‹‰é•œåƒï¼Œè™½ç„¶æœ¬åœ° push && pull ä¸€ä¸ªé•œåƒå¹¶ä¸æ˜¯ä»€ä¹ˆéš¾äº‹å„¿ï¼Œä½†å¯¹äºä¸€äº›ç‰¹å®šçš„åœºæ™¯å¦‚äº§å“æ‰“åŒ…å‘å¸ƒæµæ°´çº¿ä¸­ï¼Œè¿˜ç»§ç»­å†ä½¿ç”¨ docker è¿™ä¸ªç¬¨é‡çš„å·¥å…·æ¥æ¨æ‹‰é•œåƒçš„è¯ï¼Œæ˜¯ååˆ†è´¹æ—¶è´¹åŠ›çš„ï¼Œå…·ä½“çš„åŸç†å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰å†™çš„åšå®¢ã€Š[æ·±å…¥æµ…å‡ºå®¹å™¨é•œåƒçš„ä¸€ç”Ÿ ğŸ¤”](https://blog.k8s.li/Exploring-container-image.html)ã€‹ã€‚

è‡ªä» Kubernetes 1.20 ä¹‹åï¼ŒK8s ç¤¾åŒºä¹Ÿå¼ƒç”¨äº† Docker ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ï¼Œdocker-shim ç›¸å…³çš„ä»£ç å°†åœ¨ kubelet ä¸­ä¸å†ç»´æŠ¤ï¼Œéšåæ€èµ·äº†ä¸€æ³¢å» docker çš„æµªæ½®ã€‚é‚£ä¹ˆç°åœ¨æœ‰æ²¡æœ‰ä¸€ç§èƒ½å¤Ÿæ›¿ä»£ docker-cli çš„å·¥å…·æ¥ä¼ è¾“é•œåƒå‘¢ï¼Ÿä»Šå¤©ç»™å¤§å®¶ä»‹ç»ä¸€ä¸ªèƒ½å¤Ÿå®Œå…¨æ›¿ä»£ docker-cli æ¥æ¬è¿é•œåƒçš„å·¥å…·ï¼šskopeoã€‚è¿™ç©æ„å„¿æ¯” docker-cli é«˜åˆ°ä¸çŸ¥é“å“ªé‡Œå»äº†ï¼

## å®‰è£…æ–¹å¼

å®˜æ–¹çš„å®‰è£…æ–¹å¼å‚è€ƒå®‰è£…æ–‡æ¡£å³å¯ [https://github.com/containers/skopeo/blob/main/install.md](https://github.com/containers/skopeo/blob/main/install.md)

ç”±äºæˆ‘çš„ VPS æœºå™¨æ˜¯ Ubuntu 1804 çš„ OS ï¼Œé…ç½® apt æºå¹¶æ²¡æˆåŠŸï¼Œå½“åœºç¿»è½¦ã€‚åœ¨å®˜æ–¹çš„ Makefile é‡Œåªæä¾›äº†åœ¨ nixos ä¸‹æ„å»ºé™æ€è¿æ¥çš„æ–¹å¼ï¼Œå…¶ä»– Linux å‘ç›¸ç‰ˆåªèƒ½ä½¿ç”¨åŠ¨æ€é“¾æ¥çš„æ–¹å¼æ¥ç¼–è¯‘ã€‚ä½†åŠ¨æ€é“¾æ¥çš„æ–¹å¼é€šç”¨æ€§å¤ªå·®ï¼Œæ¯”å¦‚åœ¨ ubuntu 18.04 ä¸Šä½¿ç”¨åŠ¨æ€é“¾æ¥ç¼–è¯‘çš„ skopeo åªèƒ½åœ¨ ubuntu ä¸Šä½¿ç”¨ï¼Œæ— æ³•åœ¨ centos ä¸Šä½¿ç”¨ã€‚å› ä¸ºåŠ¨æ€é“¾æ¥ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶åœ¨ä¸åŒçš„ OS ä¸Šæ‰€ä¾èµ–çš„åº“æ–‡ä»¶æ˜¯ä¸ä¸€æ ·çš„ã€‚æ‰€ä»¥è¿˜æ˜¯å¦è¾Ÿè¹Šå¾„ï¼Œäº²è‡ªç¼–è¯‘ä¸€ä¸ªã€‚

- Clone repo

```bash
$ SKOPEO_VERSION=v1.3.0
$ git clone --branch ${SKOPEO_VERSION} https://github.com/containers/skopeo
$ cd skopeo
```

- docker  build

```bash
$ BUILD_IMAGE=nixos/nix:2.3.12
$ docker run --rm -t -v $PWD:/build ${BUILD_IMAGE} \
sh -c "cd /build && nix build -f nix && cp ./result/bin/skopeo skopeo"
```

- ä½¿ç”¨ `nixos/nix:2.3.12` æ¥æ„å»ºé™æ€é“¾æ¥çš„ skopeo äºŒè¿›åˆ¶æ–‡ä»¶éœ€è¦å®Œæ•´æ„å»º skopeo æ‰€æœ‰çš„ä¾èµ–ï¼Œæ¯”å¦‚ glibcã€systemdã€golang ç­‰ï¼Œæ‰€ä»¥æ„å»ºååˆ†è€—æ—¶ã€‚åœ¨ä¸€å° 4c8G çš„æœºå™¨ä¸Šæ„å»ºç”¨äº†å°†è¿‘åŠä¸ªå°æ—¶ï¼Œåœ¨ GitHub Action çš„ runner æœºå™¨ä¸Šæ„å»ºéœ€è¦å°†è¿‘[ä¸€ä¸ªå°æ—¶](https://github.com/k8sli/skopeo/actions/runs/1010266302)ã€‚

![img](https://p.k8s.li/skopeo-github-action-build.png)

- ä½¿ç”¨ GitHub Action æ„å»º

```yaml
---
name: build static binary
on: push
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      BUILD_IMAGE: "nixos/nix:2.3.12"
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Build static binary
        run: |
          docker run --rm -t -v $PWD:/build --name builder ${BUILD_IMAGE} \
          sh -c "cd /build && nix build -f nix && cp ./result/bin/skopeo skopeo-linux-amd64"

      - name: Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: skopeo-linux-amd64
```

ä¸è¿‡ä¹Ÿå¯ä»¥ä½¿ç”¨ go build çš„æ–¹å¼æ„å»ºå‡ºé™æ€é“¾æ¥çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¦‚ä¸‹ `Dockerfile`

```dockerfile
FROM golang:1.14-buster as skopeo-builder
ARG SKOPEO_VERSION=v1.2.0
RUN apt-get update \
    && apt-get install -y -qq libdevmapper-dev libgpgme11-dev
ENV GOPATH=/
WORKDIR /src/github.com/containers/skopeo
RUN git clone --branch ${SKOPEO_VERSION} https://github.com/containers/skopeo . \
 && CGO_ENABLE=0 GO111MODULE=on go build -mod=vendor "-buildmode=pie" -ldflags '-extldflags "-static"' -gcflags "" \
 -tags "exclude_graphdriver_devicemapper exclude_graphdriver_btrfs containers_image_openpgp" -o /usr/bin/skopeo ./cmd/skopeo
FROM alpine:3.12
COPY --from=skopeo-builder /usr/bin/skopeo /usr/bin/skopeo
# FROM scratch
# COPY --from=skopeo-builder /usr/bin/skopeo /skopeo
# DOCKER_BUILDKIT=1 docker build -o type=local,dest=$PWD -f Dockerfile .
```

- [é€šè¿‡ GitHub Action æ¥ç¼–è¯‘](https://github.com/k8sli/skopeo/blob/main/.github/workflows/build-static-binary.yaml)

```yaml
---
name: build static binary
on:
  push:
    tags:
      - 'v*'
env:
  BUILDER_IMAGE: ghcr.io/k8sli/nixos-nix:v2.3.12

jobs:
  build-linux-amd64:
    runs-on: ubuntu-latest
    env:
      ARCH: "amd64"
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Build skopeo binary file
        run: |
          DIGEST=$(skopeo --insecure-policy --override-arch ${ARCH} inspect docker://${BUILDER_IMAGE} | jq -r '.Digest')
          docker run --rm -t -v $PWD:/build ${BUILDER_IMAGE}@${DIGEST} \
          sh -c "cd /build && nix build -f nix && cp ./result/bin/skopeo skopeo-linux-${{ env.ARCH }}"
      - name: Upload binary artifact
        uses: actions/upload-artifact@v2
        with:
          path: skopeo-linux-${{ env.ARCH }}
          name: skopeo-binary-${{ github.run_number }}-${{ env.ARCH }}

  build-linux-arm64:
    runs-on: ubuntu-latest
    env:
      ARCH: "arm64"
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Build skopeo binary file
        run: |
          DIGEST=$(skopeo --insecure-policy --override-arch ${ARCH} inspect docker://${BUILDER_IMAGE} | jq -r '.Digest')
          docker run --rm -t -v $PWD:/build ${BUILDER_IMAGE}@${DIGEST} \
          sh -c "cd /build && nix build -f nix && cp ./result/bin/skopeo skopeo-linux-${{ env.ARCH }}"
      - name: Upload binary artifact
        uses: actions/upload-artifact@v2
        with:
          path: skopeo-linux-${{ env.ARCH }}
          name: skopeo-binary-${{ github.run_number }}-${{ env.ARCH }}

  release:
    runs-on: ubuntu-latest
    needs: [build-linux-amd64,build-linux-arm64]
    steps:
      - name: Download artifact from build-linux-amd64
        uses: actions/download-artifact@v2
        with:
          name: skopeo-binary-${{ github.run_number }}-amd64

      - name: Download artifact from build-linux-arm64
        uses: actions/download-artifact@v2
        with:
          name: skopeo-binary-${{ github.run_number }}-arm64

      - name: Release and upload binary files
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: |
            skopeo-linux-amd64
            skopeo-linux-arm64
```

## ä¸Šæ‰‹ä½“éªŒ

- copyï¼šå¤åˆ¶ä¸€ä¸ªé•œåƒä» A åˆ° Bï¼Œè¿™é‡Œçš„ A å’Œ B å¯ä»¥ä¸ºæœ¬åœ° docker é•œåƒæˆ–è€… registry ä¸Šçš„é•œåƒï¼›
- inspectï¼šæŸ¥çœ‹ä¸€ä¸ªé•œåƒçš„ manifest æˆ–è€… image config è¯¦ç»†ä¿¡æ¯ï¼›
- deleteï¼šåˆ é™¤ä¸€ä¸ªé•œåƒ tagï¼Œå¯ä»¥æ˜¯æœ¬åœ° docker é•œåƒæˆ–è€… registry ä¸Šçš„é•œåƒï¼›
- list-tagsï¼šåˆ—å‡ºä¸€ä¸ª registry ä¸ŠæŸä¸ªé•œåƒçš„æ‰€æœ‰ tagï¼›
- loginï¼šç™»å½•åˆ°æŸä¸ª registryï¼Œå’Œ docker login ç±»ä¼¼ï¼›
- logoutï¼š é€€å‡ºå·²ç»ç™»å½•åˆ°æŸä¸ª registry çš„ auth ä¿¡æ¯ï¼Œå’Œ docker logout ç±»ä¼¼ï¼›
- manifest-digestï¼šå‡ åœˆä¸€ä¸ªæ–‡ä»¶çš„ sha256sum å€¼ï¼›
- standalone-signã€standalone-verify è¿™ä¸¤ä¸ªæ˜¯å’Œé•œåƒåŠ å¯†ç›¸å…³çš„ï¼Œä½¿ç”¨çš„ä¸æ˜¯å¾ˆå¤šï¼›
- syncï¼šåŒæ­¥ä¸€ä¸ªé•œåƒä» A åˆ° Bï¼Œæ„Ÿè§‰å’Œ copy ä¸€æ ·ï¼Œä½† sync æ”¯æŒçš„å‚æ•°æ›´å¤šï¼ŒåŠŸèƒ½æ›´å¼ºå¤§ï¼›

```bash
  completion             generate the autocompletion script for the specified shell
  copy                   Copy an IMAGE-NAME from one location to another
  delete                 Delete image IMAGE-NAME
  help                   Help about any command
  inspect                Inspect image IMAGE-NAME
  list-tags              List tags in the transport/repository specified by the REPOSITORY-NAME
  login                  Login to a container registry
  logout                 Logout of a container registry
  manifest-digest        Compute a manifest digest of a file
  standalone-sign        Create a signature using local files
  standalone-verify      Verify a signature using local files
  sync                   Synchronize one or more images
```

### å‚æ•°

- command-timeoutï¼šå‘½ä»¤è¶…æ—¶æ—¶é—´
- debugï¼šå¼€å¯ debug æ¨¡å¼ï¼Œè¾“å‡ºè¯¦ç»†çš„æ—¥å¿—
- insecure-policyï¼š ä½¿ç”¨éå®‰å…¨çš„ policyï¼Œå¦‚æœæ²¡æœ‰é…ç½® policy çš„è¯ï¼Œéœ€è¦åŠ ä¸Šè¯¥å‚æ•°
- override-archï¼šå¤„ç†é•œåƒæ—¶è¦†ç›–å®¢æˆ·ç«¯ CPU ä½“ç³»æ¶æ„ï¼Œå¦‚åœ¨ amd64 çš„æœºå™¨ä¸Šç”¨ skopeo å¤„ç† arm64 çš„é•œåƒ
- override-osï¼š å¤„ç†é•œåƒæ—¶è¦†ç›–å®¢æˆ·ç«¯ OS

```bash
Flags:
      --command-timeout duration   timeout for the command execution
      --debug                      enable debug output
  -h, --help                       help for skopeo
      --insecure-policy            run the tool without any policy check
      --override-arch ARCH         use ARCH instead of the architecture of the machine for choosing images
      --override-os OS             use OS instead of the running OS for choosing images
      --override-variant VARIANT   use VARIANT instead of the running architecture variant for choosing images
      --policy string              Path to a trust policy file
      --registries.d DIR           use registry configuration files in DIR (e.g. for container signature storage)
      --tmpdir string              directory used to store temporary files
  -v, --version                    Version for Skopeo
```

ä¸€ä¸‹æ˜¯æˆ‘åœ¨ä½¿ç”¨ skopeo å‘½ä»¤æ—¶å€™çš„ä¸€äº›å‚æ•°

```bash
--insecure-policy --src-tls-verify=false --dest-tls-verify=false
```

### IMAGE NAMES é•œåƒæ ¼å¼ ğŸ¤”ï¸

åœ¨ä½¿ç”¨ skopeo ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆè¦çŸ¥é“åœ¨å‘½ä»¤è¡Œä¸­é•œåƒçš„æ ¼å¼ï¼Œä¸‹é¢æ˜¯å®˜æ–¹è¯¦ç»†çš„æ–‡æ¡£æ ¼å¼ã€‚æ— è®ºæˆ‘ä»¬çš„ src é•œåƒè¿˜æ˜¯ dest é•œåƒéƒ½è¦æ»¡è¶³ä»¥ä¸‹æ ¼å¼æ‰å¯ä»¥ã€‚

> Most commands refer to container images, using a *transport* `:` *details* format. The following formats are supported:

> **containers-storage:***docker-reference* An image located in a local containers/storage image store. Both the location and image store are specified in /etc/containers/storage.conf. (Backend for Podman, CRI-O, Buildah and friends)

> **dir:***path* An existing local directory *path* storing the manifest, layer tarballs and signatures as individual files. This is a non-standardized format, primarily useful for debugging or noninvasive container inspection.

> **docker://***docker-reference* An image in a registry implementing the "Docker Registry HTTP API V2". By default, uses the authorization state in either `$XDG_RUNTIME_DIR/containers/auth.json`, which is set using `(skopeo login)`. If the authorization state is not found there, `$HOME/.docker/config.json` is checked, which is set using `(docker login)`.

> **docker-archive:***path*****[**:***docker-reference*] An image is stored in the `docker save` formatted file. *docker-reference* is only used when creating such a file, and it must not contain a digest.

> **docker-daemon:***docker-reference* An image *docker-reference* stored in the docker daemon internal storage. *docker-reference* must contain either a tag or a digest. Alternatively, when reading images, the format can be docker-daemon:algo:digest (an image ID).

> **oci:***path***:***tag* An image *tag* in a directory compliant with "Open Container Image Layout Specification" at *path*.

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™å‡ ç§é•œåƒçš„åå­—ï¼Œå¯¹åº”ç€é•œåƒå­˜åœ¨çš„æ–¹å¼ï¼Œä¸åŒå­˜åœ¨çš„æ–¹å¼å¯¹é•œåƒçš„ layer å¤„ç†çš„æ–¹å¼ä¹Ÿä¸ä¸€æ ·ï¼Œæ¯”å¦‚ `docker://` è¿™ç§æ–¹å¼æ˜¯å­˜åœ¨ registry ä¸Šçš„ï¼Œ`docker-daemon:` æ˜¯å­˜åœ¨æœ¬åœ° docker pull ä¸‹æ¥çš„ï¼Œå†æ¯”å¦‚ `docker-archive` æ˜¯é€šè¿‡ docker save å‡ºæ¥çš„é•œåƒã€‚åŒä¸€ä¸ªé•œåƒæœ‰è¿™å‡ ç§å­˜åœ¨çš„æ–¹å¼å°±åƒæ°´åˆ†å­æœ‰æ°”ä½“ã€æ¶²ä½“ã€å›ºä½“ä¸€æ ·ã€‚å¯ä»¥è¿™æ ·å»ç†è§£ï¼Œä»–ä»¬è¡¨è¿°çš„éƒ½æ˜¯åŒä¸€ä¸ªé•œåƒï¼Œåªä¸è¿‡æ˜¯å­˜åœ¨çš„æ–¹å¼ä¸ä¸€æ ·è€Œå·²ã€‚

IMAGE NAMESï¼ˆé•œåƒæ ¼å¼ï¼‰examplecontainers-storage:containers-storage:dir:dir:/PATHdocker://docker://k8s.gcr.io/kube-apiserver:v1.17.5docker-daemon:docker-daemon:alpine:latestdocker-archive:docker-archive:alpine.tar (docker save)oci:oci:alpine:latest

### skopeo login

åœ¨ä½¿ç”¨ skopeo å‰å¦‚æœ src æˆ– dest é•œåƒæ˜¯åœ¨ registry ä¸­çš„ï¼Œå¦‚æœé public çš„é•œåƒéœ€è¦ç›¸åº”çš„ auth è®¤è¯ï¼Œå¯ä»¥ä½¿ç”¨ docker login æˆ–è€… skopeo login çš„æ–¹å¼ç™»å½•åˆ° registryï¼Œç”Ÿæˆå¦‚ä¸‹æ ¼å¼çš„ registry ç™»å½•é…ç½®æ–‡ä»¶ã€‚

```json
$ jq "." ~/.docker/config.json
{
  "auths": {
    "https://index.docker.io/v1/": {
      "auth": "d2sdwdaqWMasss7bSVlJFpmQE43Sw=="
    }
  },
  "HttpHeaders": {
    "User-Agent": "Docker-Client/19.03.5 (linux)"
  },
  "experimental": "enabled"
}
```

### skopeo copy

> Copy an IMAGE-NAME from one location to another

> å°†ä¸€ä¸ªé•œåƒä» A å¤åˆ¶åˆ° B

æ³¨æ„ä¸€ä¸‹ï¼Œè¿™é‡Œçš„ location å°±æ˜¯æŒ‡çš„ä¸Šé¢æåˆ°çš„ `IMAGE NAMES` ï¼Œä¹Ÿå°±æ˜¯è¯´ `skopeo copy src dest` å¯ä»¥æœ‰ 6*6=36 ç§ç»„åˆï¼æ¯”å¦‚æˆ‘å¯ä»¥å°†ä¸€ä¸ªé•œåƒä»ä¸€ä¸ª registry å¤åˆ¶åˆ°å¦ä¸€ä¸ª registryï¼š`skopeo copy docker://IMAGE_NAME docker://IMAGE_NAME`ï¼›æˆ–è€…å°†ä¸€ä¸ªé•œåƒä» registry ä¸­å¤åˆ¶åˆ°ä¸€ä¸ªæœ¬åœ°ç›®å½• `skopeo copy docker://k8s.gcr.io/pause:3.3 dir:pause:3.3`

- ä» regsitry A åˆ° registry B å¤åˆ¶é•œåƒ

```bash
$ skopeo copy docker://k8s.gcr.io/kube-apiserver:v1.17.5 docker://hub.k8s.li/kube-apiserver:v1.17.5 --dest-authfile /root/.docker/config.json
Getting image source signatures
Copying blob 597de8ba0c30 done
Copying blob e13a88fa950c done
Copying config f640481f6d done
Writing manifest to image destination
Storing signatures
```

> skopeo è¾“å‡ºçš„æ—¥å¿—æ˜¾ç¤ºæ˜¯ Copying blob 597de8ba0c30 done.å¯ä»¥çœ‹åˆ° skopeo æ˜¯ç›´æ¥ä» registry ä¸­ copy é•œåƒ layer çš„ blob æ–‡ä»¶ï¼Œä¼ è¾“æ˜¯é•œåƒåœ¨ registry ä¸­å­˜å‚¨çš„åŸå§‹æ ¼å¼ã€‚

- å°†é•œåƒä» registry å¤åˆ¶åˆ°æœ¬åœ°ç›®å½•

```bash
$ skopeo copy docker://k8s.gcr.io/pause:3.3 dir:pause:3.3
Getting image source signatures
Copying blob aeab776c4837 done
Copying config 0184c1613d done
Writing manifest to image destination
Storing signatures
$ tree pause:3.3
pause:3.3
â”œâ”€â”€ 0184c1613d92931126feb4c548e5da11015513b9e4c104e7305ee8b53b50a9da
â”œâ”€â”€ aeab776c48375e1a61810a0a5f59e982e34425ff505a01c2b57dcedc6799c17b
â”œâ”€â”€ manifest.json
â””â”€â”€ version

# æŸ¥çœ‹é•œåƒçš„ manifest æ–‡ä»¶

$ jq '.' pause:3.3/manifest.json
{
  "schemaVersion": 2,
  "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
  "config": {
    "mediaType": "application/vnd.docker.container.image.v1+json",
    "size": 743,
    "digest": "sha256:0184c1613d92931126feb4c548e5da11015513b9e4c104e7305ee8b53b50a9da"
  },
  "layers": [
    {
      "mediaType": "application/vnd.docker.image.rootfs.diff.tar.gzip",
      "size": 296517,
      "digest": "sha256:aeab776c48375e1a61810a0a5f59e982e34425ff505a01c2b57dcedc6799c17b"
    }
  ]
}

# æ ¹æ® manifest æ–‡ä»¶æŸ¥çœ‹é•œåƒçš„ image config æ–‡ä»¶

$ jq '.' pause:3.3/0184c1613d92931126feb4c548e5da11015513b9e4c104e7305ee8b53b50a9da

{
  "architecture": "amd64",
  "config": {
    "Env": [
      "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
    ],
    "Entrypoint": [
      "/pause"
    ],
    "WorkingDir": "/",
    "OnBuild": null
  },
  "created": "2020-05-02T09:46:29.068489061Z",
  "history": [
    {
      "created": "2020-05-02T09:46:29.068489061Z",
      "created_by": "ARG ARCH",
      "comment": "buildkit.dockerfile.v0",
      "empty_layer": true
    },
    {
      "created": "2020-05-02T09:46:29.068489061Z",
      "created_by": "ADD bin/pause-amd64 /pause # buildkit",
      "comment": "buildkit.dockerfile.v0"
    },
    {
      "created": "2020-05-02T09:46:29.068489061Z",
      "created_by": "ENTRYPOINT [\"/pause\"]",
      "comment": "buildkit.dockerfile.v0",
      "empty_layer": true
    }
  ],
  "os": "linux",
  "rootfs": {
    "type": "layers",
    "diff_ids": [
      "sha256:48a5e87615149095fad57d5db80f2cd9728b5562900eccb32842a45e8e8a61ae"
    ]
  }
}
```

- å°†é•œåƒä» registry å¤åˆ¶åˆ°æœ¬åœ°ç›®å½•ï¼Œä»¥ OCI æ ¼å¼ä¿å­˜

```bash
$ skopeo copy docker://k8s.gcr.io/pause:3.3 oci:images
Getting image source signatures
Copying blob aeab776c4837 done
Copying config fa5df7713f done
Writing manifest to image destination
Storing signatures
$ tree images
images
â”œâ”€â”€ blobs
â”‚   â””â”€â”€ sha256
â”‚       â”œâ”€â”€ 3450ba84b8fbfd12cbf58710c0b5678f4311a888d4d5c42b053faefa1af4f8be
â”‚       â”œâ”€â”€ aeab776c48375e1a61810a0a5f59e982e34425ff505a01c2b57dcedc6799c17b
â”‚       â””â”€â”€ fa5df7713fc78f96e377d236b353d33815073105bbacd381e50705e576ce4da5
â”œâ”€â”€ index.json
â””â”€â”€ oci-layout
```

- æ›¿ä»£ docker push åŠŸèƒ½ï¼Œå°†é•œåƒä» docker æœ¬åœ°å­˜å‚¨ push åˆ° registry ä¸­

```bash
$ skopeo copy docker-daemon:alpine:3.12 docker://hub.k8s.li/library/alpine:3.12
Getting image source signatures
Copying blob 32f366d666a5 done
Copying config 13621d1b12 done
Writing manifest to image destination
Storing signatures
```

### skopeo sync

Skopeo sync çš„åŠŸèƒ½åŸºæœ¬ä¸Šç­‰åŒäºé˜¿é‡Œäº‘çš„ [image-syncer](https://github.com/AliyunContainerService/image-syncer) å·¥å…·ï¼Œä¸è¿‡ä¸ªäººè§‰ç€ skopeo è¦æ¯” image-syncer æ›´å¼ºå¤§ï¼Œçµæ´»æ€§æ›´å¼ºä¸€äº›ï¼Œæ±è¿˜åœ¨ä½¿ç”¨ image-syncer çš„è¯ï¼Œå¼ºçƒˆå»ºè®®ä½ ä½¿ç”¨ skopeo sync æ›¿ä»£å®ƒ ğŸ˜‚ã€‚

- skopeo sync é•œåƒåŒæ­¥æ–‡ä»¶

```yaml
registry.example.com:
    images:
        busybox: []
        redis:
            - "1.0"
            - "2.0"
            - "sha256:111111"
    images-by-tag-regex:
        nginx: ^1\.13\.[12]-alpine-perl$
    credentials:
        username: john
        password: this is a secret
    tls-verify: true
    cert-dir: /home/john/certs
quay.io:
    tls-verify: false
    images:
        coreos/etcd:
            - latest
```

- Image-syncer é•œåƒåŒæ­¥é…ç½®æ–‡ä»¶

```yaml
# registry ç™»å½•é…ç½®

{
    "quay.io": {        // This "registry" or "registry/namespace" string should be the same as registry or registry/namespace used below in "images" field.
                            // The format of "registry/namespace" will be more prior matched than "registry"
        "username": "xxx",
        "password": "xxxxxxxxx",
        "insecure": true         // "insecure" field needs to be true if this registry is a http service, default value is false, version of image-syncer need to be later than v1.0.1 to support this field
    },
    "registry.cn-beijing.aliyuncs.com": {
        "username": "xxx",
        "password": "xxxxxxxxx"
    },
    "registry.hub.docker.com": {
        "username": "xxx",
        "password": "xxxxxxxxxx"
    },
    "quay.io/coreos": {     // "registry/namespace" format is supported after v1.0.3 of image-syncer
        "username": "abc",
        "password": "xxxxxxxxx",
        "insecure": true
    }
}
# é•œåƒé…ç½®
{
    "quay.io/coreos/kube-rbac-proxy": "quay.io/ruohe/kube-rbac-proxy",
    "xxxx":"xxxxx",
    "xxx/xxx/xx:tag1,tag2,tag3":"xxx/xxx/xx"
}
```

- å°†é•œä» registry A åŒæ­¥åˆ° registry B

```bash
$ skopeo sync --src docker --dest docker k8s.gcr.io/pause:3.3 hub.k8s.li
INFO[0000] Tag presence check                            imagename="k8s.gcr.io/pause:3.3" tagged=true
INFO[0000] Copying image tag 1/1                         from="docker://k8s.gcr.io/pause:3.3" to="docker://hub.k8s.li/pause:3.3"
Getting image source signatures
Copying blob aeab776c4837 done
Copying config 0184c1613d done
Writing manifest to image destination
Storing signatures
INFO[0000] Synced 1 images from 1 sources
```

- å°†ä¸€ä¸ªé•œåƒä» registry ä¸­åŒæ­¥åˆ°æœ¬åœ°ç›®å½•

```bash
$ skopeo sync --src docker --dest dir k8s.gcr.io/pause:3.3 images
images
â””â”€â”€ pause:3.3
    â”œâ”€â”€ 0184c1613d92931126feb4c548e5da11015513b9e4c104e7305ee8b53b50a9da
    â”œâ”€â”€ aeab776c48375e1a61810a0a5f59e982e34425ff505a01c2b57dcedc6799c17b
    â”œâ”€â”€ manifest.json
    â””â”€â”€ version
```

- å°†é•œåƒä»æœ¬åœ°ç›®å½•åŒæ­¥åˆ° registry ä¸­

```bash
$ skopeo sync --src dir --dest docker images hub.k8s.li
INFO[0000] Copying image ref 1/1                         from="dir:images/pause:3.3" to="docker://hub.k8s.li/pause:3.3"
Getting image source signatures
Copying blob aeab776c4837 [--------------------------------------] 0.0b / 0.0b
Copying config 0184c1613d done
Writing manifest to image destination
Storing signatures
INFO[0002] Synced 1 images from 1 sources
```

### skopeo inspect

è¿™ä¸ªå‘½ä»¤å¯ä»¥æŸ¥çœ‹ä¸€ä¸ªé•œåƒçš„ image config æˆ–è€… manifests æ–‡ä»¶ï¼Œå’Œ docker inspect å‘½ä»¤å·®ä¸å¤šã€‚ä¸åŠ  --raw å‚æ•°é»˜è®¤æ˜¯æŸ¥çœ‹é•œåƒçš„ image config æ–‡ä»¶ï¼ŒåŠ ä¸Š --raw å‚æ•°å°±æ˜¯æŸ¥çœ‹é•œåƒçš„ manifest æ–‡ä»¶ã€‚

- æŸ¥çœ‹ docker æœ¬åœ°å­˜å‚¨ä¸­çš„ä¸€ä¸ªé•œåƒçš„ image config æ–‡ä»¶

```json
$ skopeo inspect docker-daemon:alpine:latest
{
    "Name": "docker.io/library/alpine",
    "Digest": "sha256:ab84514e85b179ff569fd0042969b04f68812f23e187a927cb84664b417e0d3e",
    "RepoTags": [],
    "Created": "2021-04-14T19:19:49.594730611Z",
    "DockerVersion": "19.03.12",
    "Labels": null,
    "Architecture": "amd64",
    "Os": "linux",
    "Layers": [
        "sha256:32f366d666a541852cad754ee1cdb53a736110b550f0c2d5a46bc5ba519896b6"
    ],
    "Env": [
        "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
    ]
}
```

- æŸ¥çœ‹ registry ä¸­ä¸€ä¸ªé•œåƒçš„ manifests æ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼æ¥åˆ¤æ–­é•œåƒæ˜¯å¦å­˜åœ¨

```json
skopeo inspect docker://alpine:latest --raw | jq '.'

{
  "manifests": [
    {
      "digest": "sha256:1775bebec23e1f3ce486989bfc9ff3c4e951690df84aa9f926497d82f2ffca9d",
      "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
      "platform": {
        "architecture": "amd64",
        "os": "linux"
      },
      "size": 528
    },
    {
      "digest": "sha256:1f66b8f3041ef8575260056dedd437ed94e7bfeea142ee39ff0d795f94ff2287",
      "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
      "platform": {
        "architecture": "arm",
        "os": "linux",
        "variant": "v6"
      },
      "size": 528
    },
    {
      "digest": "sha256:8d99168167baa6a6a0d7851b9684625df9c1455116a9601835c2127df2aaa2f5",
      "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
      "platform": {
        "architecture": "arm",
        "os": "linux",
        "variant": "v7"
      },
      "size": 528
    },
    {
      "digest": "sha256:53b74ddfc6225e3c8cc84d7985d0f34666e4e8b0b6892a9b2ad1f7516bc21b54",
      "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
      "platform": {
        "architecture": "arm64",
        "os": "linux",
        "variant": "v8"
      },
      "size": 528
    },
    {
      "digest": "sha256:52a197664c8ed0b4be6d3b8372f1d21f3204822ba432583644c9ce07f7d6448f",
      "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
      "platform": {
        "architecture": "386",
        "os": "linux"
      },
      "size": 528
    },
    {
      "digest": "sha256:b421672fe4e74a3c7eff2775736e854d69e8d38b2c337063f8699de9c408ddd3",
      "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
      "platform": {
        "architecture": "ppc64le",
        "os": "linux"
      },
      "size": 528
    },
    {
      "digest": "sha256:8a22269106a31264874cc3a719c1e280e76d42dff1fa57bd9c7fe68dab574023",
      "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
      "platform": {
        "architecture": "s390x",
        "os": "linux"
      },
      "size": 528
    }
  ],
  "mediaType": "application/vnd.docker.distribution.manifest.list.v2+json",
  "schemaVersion": 2
}
```

### skopeo delete

ä½¿ç”¨è¿™ä¸ªå‘½ä»¤å¯ä»¥åˆ é™¤é•œåƒ tagã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé€šè¿‡  registry API æ¥åˆ é™¤é•œåƒçš„ tag ä»…ä»…æ˜¯åˆ é™¤äº† tag å¯¹ manifests æ–‡ä»¶çš„å¼•ç”¨ï¼Œå¹¶éçœŸæ­£å°†é•œåƒåˆ é™¤æ‰ã€‚å¦‚æœæƒ³è¦åˆ é™¤é•œåƒçš„ layer è¿˜æ˜¯éœ€è¦é€šè¿‡ registry GC çš„æ–¹å¼ï¼Œå¯å‚è€ƒä¹‹å‰å†™è¿‡çš„ä¸€ç¯‡åšå®¢ã€Š[docker registry GC åŸç†åˆ†æ](https://blog.k8s.li/registry-gc.html)ã€‹

```
$ skopeo delete docker://hub.k8s.li/library/pause:3.2 --debug
DEBU[0000] Returning credentials from /home/release/.docker/config.json
DEBU[0000] Using registries.d directory /etc/containers/registries.d for sigstore configuration
DEBU[0000]  No signature storage configuration found for hub.k8s.li/library/pause:3.2
DEBU[0000] Looking for TLS certificates and private keys in /etc/docker/certs.d/hub.k8s.li/library
DEBU[0000] Loading registries configuration "/etc/containers/registries.conf"
DEBU[0000] GET https://hub.k8s.li/library/v2/
DEBU[0000] Ping https://hub.k8s.li/library/v2/ status 401
DEBU[0000] GET https://hub.k8s.li/library/v2/library/pause/manifests/3.2
DEBU[0000] DELETE https://hub.k8s.li/library/v2/library/pause/manifests/sha256:4a1c4b21597c1b4415bdbecb28a3296c6b5e23ca4f9feeb599860a1dac6a0108
```

### skopeo list-tags

è¿™ä¸ªå‘½ä»¤å¯ç”¨äºåˆ—å‡º registry ä¸Šçš„æŸä¸ªé•œåƒçš„æ‰€æœ‰ tag ï¼Œä½¿ç”¨æ ‡å‡†çš„ registry API æ¥è·å–é•œåƒ tag

```
$ skopeo list-tags docker://k8s.gcr.io/pause
{
    "Repository": "k8s.gcr.io/pause",
    "Tags": [
        "0.8.0",
        "1.0",
        "2.0",
        "3.0",
        "3.1",
        "3.2",
        "3.3",
        "3.4.1",
        "3.5",
        "go",
        "latest",
        "test",
        "test2"
    ]
}
```

## æœ€ä½³å®è·µ

ä¸€ä¸‹ç»™å‡ºå‡ ä¸ª skopeo å·¥å…·çš„æœ€ä½³å®è·µ ğŸ˜Š

### é•œåƒåŒæ­¥

å‡å¦‚ç»™ä½ ä¸€ä¸ªé•œåƒåˆ—è¡¨ï¼Œå¦‚ [https://github.com/kubesphere/ks-installer/blob/master/scripts/images-list.txt](https://github.com/kubesphere/ks-installer/blob/master/scripts/images-list.txt)ã€‚å¦‚ä½•å°†å®ƒå¿«é€Ÿåœ°ä»ä¸€ä¸ª registry åŒæ­¥åˆ°å¦ä¸€ä¸ª registry ä¸­å‘¢ï¼Ÿè¿˜æ˜¯ skopeo copy èµ°èµ·ï¼

- images-list.txt

```
##k8s-images
kubesphere/kube-apiserver:v1.20.6
kubesphere/kube-scheduler:v1.20.6
kubesphere/kube-proxy:v1.20.6
kubesphere/kube-controller-manager:v1.20.6
kubesphere/kube-apiserver:v1.19.8
kubesphere/kube-scheduler:v1.19.8
kubesphere/kube-proxy:v1.19.8
kubesphere/kube-controller-manager:v1.19.8
kubesphere/kube-apiserver:v1.19.9
kubesphere/kube-scheduler:v1.19.9
kubesphere/kube-proxy:v1.19.9
kubesphere/kube-controller-manager:v1.19.9
kubesphere/kube-apiserver:v1.18.8
kubesphere/kube-scheduler:v1.18.8
kubesphere/kube-proxy:v1.18.8
kubesphere/kube-controller-manager:v1.18.8
kubesphere/kube-apiserver:v1.17.9
kubesphere/kube-scheduler:v1.17.9
kubesphere/kube-proxy:v1.17.9
kubesphere/kube-controller-manager:v1.17.9
kubesphere/pause:3.1
kubesphere/pause:3.2
kubesphere/etcd:v3.4.13
calico/cni:v3.16.3
calico/kube-controllers:v3.16.3
calico/node:v3.16.3
calico/pod2daemon-flexvol:v3.16.3
calico/typha:v3.16.3
kubesphere/flannel:v0.12.0
coredns/coredns:1.6.9
kubesphere/k8s-dns-node-cache:1.15.12
openebs/provisioner-localpv:2.10.1
openebs/linux-utils:2.10.0
kubesphere/nfs-client-provisioner:v3.1.0-k8s1.11
##csi-images
csiplugin/csi-neonsan:v1.2.0
csiplugin/csi-neonsan-ubuntu:v1.2.0
csiplugin/csi-neonsan-centos:v1.2.0
csiplugin/csi-provisioner:v1.5.0
csiplugin/csi-attacher:v2.1.1
csiplugin/csi-resizer:v0.4.0
csiplugin/csi-snapshotter:v2.0.1
csiplugin/csi-node-driver-registrar:v1.2.0
csiplugin/csi-qingcloud:v1.2.0
##kubesphere-images
kubesphere/ks-apiserver:v3.1.1
kubesphere/ks-console:v3.1.1
kubesphere/ks-controller-manager:v3.1.1
kubesphere/ks-installer:v3.1.1
kubesphere/kubectl:v1.20.0
kubesphere/kubectl:v1.19.0
redis:5.0.12-alpine
alpine:3.14
haproxy:2.0.22-alpine
nginx:1.14-alpine
minio/minio:RELEASE.2019-08-07T01-59-21Z
minio/mc:RELEASE.2019-08-07T23-14-43Z
mirrorgooglecontainers/defaultbackend-amd64:1.4
kubesphere/nginx-ingress-controller:v0.35.0
osixia/openldap:1.3.0
csiplugin/snapshot-controller:v3.0.3
kubesphere/kubefed:v0.7.0
kubesphere/tower:v0.2.0
kubesphere/prometheus-config-reloader:v0.42.1
kubesphere/prometheus-operator:v0.42.1
prom/alertmanager:v0.21.0
prom/prometheus:v2.26.0
prom/node-exporter:v0.18.1
kubesphere/ks-alerting-migration:v3.1.0
jimmidyson/configmap-reload:v0.3.0
kubesphere/notification-manager-operator:v1.0.0
kubesphere/notification-manager:v1.0.0
kubesphere/metrics-server:v0.4.2
kubesphere/kube-rbac-proxy:v0.8.0
kubesphere/kube-state-metrics:v1.9.7
openebs/provisioner-localpv:2.3.0
thanosio/thanos:v0.18.0
grafana/grafana:7.4.3
##kubesphere-logging-images
kubesphere/elasticsearch-oss:6.7.0-1
kubesphere/elasticsearch-curator:v5.7.6
kubesphere/fluentbit-operator:v0.5.0
kubesphere/fluentbit-operator:migrator
kubesphere/fluent-bit:v1.6.9
elastic/filebeat:6.7.0
kubesphere/kube-auditing-operator:v0.1.2
kubesphere/kube-auditing-webhook:v0.1.2
kubesphere/kube-events-exporter:v0.1.0
kubesphere/kube-events-operator:v0.1.0
kubesphere/kube-events-ruler:v0.2.0
kubesphere/log-sidecar-injector:1.1
docker:19.03
##istio-images
istio/pilot:1.6.10
istio/proxyv2:1.6.10
jaegertracing/jaeger-agent:1.17
jaegertracing/jaeger-collector:1.17
jaegertracing/jaeger-es-index-cleaner:1.17
jaegertracing/jaeger-operator:1.17.1
jaegertracing/jaeger-query:1.17
kubesphere/kiali:v1.26.1
kubesphere/kiali-operator:v1.26.1
##kubesphere-devops-images
kubesphere/ks-jenkins:2.249.1
jenkins/jnlp-slave:3.27-1
kubesphere/s2ioperator:v3.1.0
kubesphere/s2irun:v2.1.1
kubesphere/builder-base:v3.1.0
kubesphere/builder-nodejs:v3.1.0
kubesphere/builder-maven:v3.1.0
kubesphere/builder-go:v3.1.0
kubesphere/s2i-binary:v2.1.0
kubesphere/tomcat85-java11-centos7:v2.1.0
kubesphere/tomcat85-java11-runtime:v2.1.0
kubesphere/tomcat85-java8-centos7:v2.1.0
kubesphere/tomcat85-java8-runtime:v2.1.0
kubesphere/java-11-centos7:v2.1.0
kubesphere/java-8-centos7:v2.1.0
kubesphere/java-8-runtime:v2.1.0
kubesphere/java-11-runtime:v2.1.0
kubesphere/nodejs-8-centos7:v2.1.0
kubesphere/nodejs-6-centos7:v2.1.0
kubesphere/nodejs-4-centos7:v2.1.0
kubesphere/python-36-centos7:v2.1.0
kubesphere/python-35-centos7:v2.1.0
kubesphere/python-34-centos7:v2.1.0
kubesphere/python-27-centos7:v2.1.0
##openpitrix-images
kubespheredev/openpitrix-jobs:v3.1.1
##weave-scope-images
weaveworks/scope:1.13.0
##kubeedge-images
kubeedge/cloudcore:v1.6.2
kubesphere/edge-watcher:v0.1.0
kubesphere/kube-rbac-proxy:v0.5.0
kubesphere/edge-watcher-agent:v0.1.0
##example-images-images
kubesphere/examples-bookinfo-productpage-v1:1.16.2
kubesphere/examples-bookinfo-reviews-v1:1.16.2
kubesphere/examples-bookinfo-reviews-v2:1.16.2
kubesphere/examples-bookinfo-reviews-v3:1.16.2
kubesphere/examples-bookinfo-details-v1:1.16.2
kubesphere/examples-bookinfo-ratings-v1:1.16.3
busybox:1.31.1
joosthofman/wget:1.0
kubesphere/netshoot:v1.0
nginxdemos/hello:plain-text
wordpress:4.8-apache
mirrorgooglecontainers/hpa-example:latest
java:openjdk-8-jre-alpine
fluent/fluentd:v1.4.2-2.0
perl:latest
```

- sync.sh

```bash
#!/bin/bash
GREEN_COL="\\033[32;1m"
RED_COL="\\033[1;31m"
NORMAL_COL="\\033[0;39m"
SOURCE_REGISTRY=$1
TARGET_REGISTRY=$2
: ${IMAGES_LIST_FILE:="images-list.txt"}
: ${TARGET_REGISTRY:="hub.k8s.li"}
: ${SOURCE_REGISTRY:="docker.io"}

BLOBS_PATH="docker/registry/v2/blobs/sha256"
REPO_PATH="docker/registry/v2/repositories"
set -eo pipefail

CURRENT_NUM=0
ALL_IMAGES="$(sed -n '/#/d;s/:/:/p' ${IMAGES_LIST_FILE} | sort -u)"
TOTAL_NUMS=$(echo "${ALL_IMAGES}" | wc -l)

skopeo_copy() {
 if skopeo copy --insecure-policy --src-tls-verify=false --dest-tls-verify=false \
 --override-arch amd64 --override-os linux -q docker://$1 docker://$2; then
 echo -e "$GREEN_COL Progress: ${CURRENT_NUM}/${TOTAL_NUMS} sync $1 to $2 successful $NORMAL_COL"
 else
 echo -e "$RED_COL Progress: ${CURRENT_NUM}/${TOTAL_NUMS} sync $1 to $2 failed $NORMAL_COL"
 exit 2
 fi
}

for image in ${ALL_IMAGES}; do
 let CURRENT_NUM=${CURRENT_NUM}+1
 skopeo_copy ${SOURCE_REGISTRY}/${image} ${TARGET_REGISTRY}/${image}
done
```

- `bash sync.sh docker.io ``localhost:5000`

```bash
$ bash sync.sh docker.io localhost:5000
Progress: 1/143 sync docker.io/alpine:3.14 to localhost:5000/alpine:3.14 successful
Progress: 2/143 sync docker.io/busybox:1.31.1 to localhost:5000/busybox:1.31.1 successful
Progress: 3/143 sync docker.io/calico/cni:v3.16.3 to localhost:5000/calico/cni:v3.16.3 successful
Progress: 4/143 sync docker.io/calico/kube-controllers:v3.16.3 to localhost:5000/calico/kube-controllers:v3.16.3 successful
Progress: 141/143 sync docker.io/thanosio/thanos:v0.18.0 to localhost:5000/thanosio/thanos:v0.18.0 successful
Progress: 142/143 sync docker.io/weaveworks/scope:1.13.0 to localhost:5000/weaveworks/scope:1.13.0 successful
Progress: 143/143 sync docker.io/wordpress:4.8-apache to localhost:5000/wordpress:4.8-apache successful
```

### ä½¿ç”¨ registry å­˜å‚¨ç‰¹æ€§

å°†é•œåƒä» registry ä¸­åŒæ­¥åˆ°æœ¬åœ°ç›®å½•ï¼Œä½¿ç”¨ registry å­˜å‚¨çš„ç‰¹æ€§ï¼Œå°†æœ¬åœ°ç›®å½•ä¸­çš„é•œåƒè½¬æ¢æˆ registry å­˜å‚¨çš„æ ¼å¼ã€‚è¿™æ ·å­çš„å¥½å¤„å°±æ˜¯å¯ä»¥å»é™¤ä¸€äº› skopeo dir ä¸­é‡å¤çš„ layersï¼Œå‡å°‘é•œåƒçš„æ€»å¤§å°ã€‚å…·ä½“çš„åŸç†å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰å†™è¿‡çš„ ã€Š[å¦‚ä½•ä½¿ç”¨ registry å­˜å‚¨çš„ç‰¹æ€§](https://blog.k8s.li/skopeo-to-registry.html)ã€‹

- sync.sh

```bash
#!/bin/bash
GREEN_COL="\\033[32;1m"
RED_COL="\\033[1;31m"
NORMAL_COL="\\033[0;39m"
SOURCE_REGISTRY=$1
TARGET_REGISTRY=$2
IMAGES_DIR=$2
: ${IMAGES_DIR:="images"}
: ${IMAGES_LIST_FILE:="images-list.txt"}
: ${TARGET_REGISTRY:="hub.k8s.li"}
: ${SOURCE_REGISTRY:="docker.io"}
BLOBS_PATH="docker/registry/v2/blobs/sha256"
REPO_PATH="docker/registry/v2/repositories"
set -eo pipefail
CURRENT_NUM=0
ALL_IMAGES="$(sed -n '/#/d;s/:/:/p' ${IMAGES_LIST_FILE} | sort -u)"
TOTAL_NUMS=$(echo "${ALL_IMAGES}" | wc -l)
skopeo_sync() {
 if skopeo sync --insecure-policy --src-tls-verify=false --dest-tls-verify=false \
 --override-arch amd64 --override-os linux --src docker --dest dir $1 $2 > /dev/null; then
 echo -e "$GREEN_COL Progress: ${CURRENT_NUM}/${TOTAL_NUMS} sync $1 to $2 successful $NORMAL_COL"
 else
 echo -e "$RED_COL Progress: ${CURRENT_NUM}/${TOTAL_NUMS} sync $1 to $2 failed $NORMAL_COL"
 exit 2
 fi
}
convert_images() {
 rm -rf ${IMAGES_DIR}; mkdir -p ${IMAGES_DIR}
 for image in ${ALL_IMAGES}; do
 let CURRENT_NUM=${CURRENT_NUM}+1
 image_name=${image%%:*}
 image_tag=${image##*:}
 image_repo=${image%%/*}
 skopeo_sync ${SOURCE_REGISTRY}/${image} ${IMAGES_DIR}/${image_repo}
 manifest="${IMAGES_DIR}/${image}/manifest.json"
 manifest_sha256=$(sha256sum ${manifest} | awk '{print $1}')
 mkdir -p ${BLOBS_PATH}/${manifest_sha256:0:2}/${manifest_sha256}
 ln -f ${manifest} ${BLOBS_PATH}/${manifest_sha256:0:2}/${manifest_sha256}/data
 # make image repositories dir
 mkdir -p ${REPO_PATH}/${image_name}/{_uploads,_layers,_manifests}
 mkdir -p ${REPO_PATH}/${image_name}/_manifests/revisions/sha256/${manifest_sha256}
 mkdir -p ${REPO_PATH}/${image_name}/_manifests/tags/${image_tag}/{current,index/sha256}
 mkdir -p ${REPO_PATH}/${image_name}/_manifests/tags/${image_tag}/index/sha256/${manifest_sha256}
 # create image tag manifest link file
 echo -n "sha256:${manifest_sha256}" > ${REPO_PATH}/${image_name}/_manifests/tags/${image_tag}/current/link
 echo -n "sha256:${manifest_sha256}" > ${REPO_PATH}/${image_name}/_manifests/revisions/sha256/${manifest_sha256}/link
 echo -n "sha256:${manifest_sha256}" > ${REPO_PATH}/${image_name}/_manifests/tags/${image_tag}/index/sha256/${manifest_sha256}/link
 # link image layers file to registry blobs dir
 for layer in $(sed '/v1Compatibility/d' ${manifest} | grep -Eo "\b[a-f0-9]{64}\b"); do
 mkdir -p ${BLOBS_PATH}/${layer:0:2}/${layer}
 mkdir -p ${REPO_PATH}/${image_name}/_layers/sha256/${layer}
 echo -n "sha256:${layer}" > ${REPO_PATH}/${image_name}/_layers/sha256/${layer}/link
 ln -f ${IMAGES_DIR}/${image}/${layer} ${BLOBS_PATH}/${layer:0:2}/${layer}/data
 done
 done
}

convert_images
```

- install.sh

ä½¿ç”¨è¿™ä¸ªè„šæœ¬å°† registry å­˜å‚¨ä¸­çš„é•œåƒè½¬æ¢æˆ skopeo dir çš„æ–¹å¼ï¼Œç„¶åå†å°†é•œåƒåŒæ­¥åˆ° registry ä¸­ã€‚

```bash
#!/bin/bash
REGISTRY_DOMAIN="harbor.k8s.li"
REGISTRY_PATH="/var/lib/registry"
# åˆ‡æ¢åˆ° registry å­˜å‚¨ä¸»ç›®å½•ä¸‹
cd ${REGISTRY_PATH}
gen_skopeo_dir() {
   # å®šä¹‰ registry å­˜å‚¨çš„ blob ç›®å½• å’Œ repositories ç›®å½•ï¼Œæ–¹ä¾¿åé¢ä½¿ç”¨
    BLOB_DIR="docker/registry/v2/blobs/sha256"
    REPO_DIR="docker/registry/v2/repositories"
    # å®šä¹‰ç”Ÿæˆ skopeo ç›®å½•
    SKOPEO_DIR="docker/skopeo"
    # é€šè¿‡ find å‡º current æ–‡ä»¶å¤¹å¯ä»¥å¾—åˆ°æ‰€æœ‰å¸¦ tag çš„é•œåƒï¼Œå› ä¸ºä¸€ä¸ª tag å¯¹åº”ä¸€ä¸ª current ç›®å½•
    for image in $(find ${REPO_DIR} -type d -name "current"); do
        # æ ¹æ®é•œåƒçš„ tag æå–é•œåƒçš„åå­—
        name=$(echo ${image} | awk -F '/' '{print $5"/"$6":"$9}')
        link=$(cat ${image}/link | sed 's/sha256://')
        mfs="${BLOB_DIR}/${link:0:2}/${link}/data"
        # åˆ›å»ºé•œåƒçš„ç¡¬é“¾æ¥éœ€è¦çš„ç›®å½•
        mkdir -p "${SKOPEO_DIR}/${name}"
        # ç¡¬é“¾æ¥é•œåƒçš„ manifests æ–‡ä»¶åˆ°ç›®å½•çš„ manifest æ–‡ä»¶
        ln ${mfs} ${SKOPEO_DIR}/${name}/manifest.json
        # ä½¿ç”¨æ­£åˆ™åŒ¹é…å‡ºæ‰€æœ‰çš„ sha256 å€¼ï¼Œç„¶åæ’åºå»é‡
        layers=$(grep -Eo "\b[a-f0-9]{64}\b" ${mfs} | sort -n | uniq)
        for layer in ${layers}; do
          # ç¡¬é“¾æ¥ registry å­˜å‚¨ç›®å½•é‡Œçš„é•œåƒ layer å’Œ images config åˆ°é•œåƒçš„ dir ç›®å½•
            ln ${BLOB_DIR}/${layer:0:2}/${layer}/data ${SKOPEO_DIR}/${name}/${layer}
        done
    done
}
sync_image() {
    # ä½¿ç”¨ skopeo sync å°† dir æ ¼å¼çš„é•œåƒåŒæ­¥åˆ° harbor
    for project in $(ls ${SKOPEO_DIR}); do
        skopeo sync --insecure-policy --src-tls-verify=false --dest-tls-verify=false \
        --src dir --dest docker ${SKOPEO_DIR}/${project} ${REGISTRY_DOMAIN}/${project}
    done
}
gen_skopeo_dir
```

### ä» registry å­˜å‚¨ä¸­ select å‡ºé•œåƒ

å…ˆå°†é•œåƒåŒæ­¥åˆ°ä¸€ä¸ª registry ä¸­ï¼Œå†å°†é•œåƒä» registry å­˜å‚¨ä¸­æå‡ºæ¥ã€‚è¿™ä¸ª registry å¯ä»¥å½“ä½œä¸€ä¸ªé•œåƒå­˜å‚¨çš„æ± å­ï¼Œæˆ‘ä»¬ä½¿ç”¨ Linux ä¸­ç¡¬é“¾æ¥çš„ç‰¹æ€§å°†é•œåƒ `"å¤åˆ¶"` ä¸€ä»½å‡ºæ¥ï¼Œç„¶åå†æ‰“ä¸€ä¸ª tar åŒ…ã€‚è¿™æ ·åšçš„å¥½å¤„å°±æ˜¯æ¯æ¬¡æ‰“åŒ…é•œåƒçš„æ—¶å€™éƒ½èƒ½å¤ç”¨å†å²çš„é•œåƒæ•°æ®ï¼Œè€Œä¸”æ€§èƒ½æå¿«ã€‚å…·ä½“çš„åŸç†å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„åšå®¢ã€Š[ä»€ä¹ˆï¼Ÿå‘å¸ƒæµæ°´çº¿ä¸­é•œåƒâ€œåŒæ­¥â€é€Ÿåº¦åˆæå‡äº† 15 å€ ï¼](https://blog.k8s.li/select-registry-images.html)ã€‹

- å…ˆå°†é•œåƒåŒæ­¥åˆ°ä¸€ä¸ªå›ºå®šçš„ registry ä¸­

```
$ bash sync.sh docker.io localhost:5000
```

- å†ä½¿ç”¨è¯¥è„šæœ¬å°†é•œåƒä» registry å­˜å‚¨ä¸­æå‡ºæ¥

```bash
#!/bin/bash
set -eo pipefail
IMAGES_LIST="$1"
REGISTRY_PATH="$2"
OUTPUT_DIR="$3"
BLOB_DIR="docker/registry/v2/blobs/sha256"
REPO_DIR="docker/registry/v2/repositories"
rm -rf ${OUTPUT_DIR}; mkdir -p ${OUTPUT_DIR}
for image in $(find ${IMAGES_LIST} -type f -name "*.list" | xargs grep -Ev '^#|^/' | grep ':'); do
    image_tag=${image##*:}
    image_name=${image%%:*}
    tag_link=${REGISTRY_PATH}/${REPO_DIR}/${image_name}/_manifests/tags/${image_tag}/current/link
    manifest_sha256=$(sed 's/sha256://' ${tag_link})
    manifest=${REGISTRY_PATH}/${BLOB_DIR}/${manifest_sha256:0:2}/${manifest_sha256}/data
    mkdir -p ${OUTPUT_DIR}/${BLOB_DIR}/${manifest_sha256:0:2}/${manifest_sha256}
    ln -f ${manifest} ${OUTPUT_DIR}/${BLOB_DIR}/${manifest_sha256:0:2}/${manifest_sha256}/data
    # make image repositories dir
    mkdir -p ${OUTPUT_DIR}/${REPO_DIR}/${image_name}/{_uploads,_layers,_manifests}
    mkdir -p ${OUTPUT_DIR}/${REPO_DIR}/${image_name}/_manifests/revisions/sha256/${manifest_sha256}
    mkdir -p ${OUTPUT_DIR}/${REPO_DIR}/${image_name}/_manifests/tags/${image_tag}/{current,index/sha256}
    mkdir -p ${OUTPUT_DIR}/${REPO_DIR}/${image_name}/_manifests/tags/${image_tag}/index/sha256/${manifest_sha256}
    # create image tag manifest link file
    echo -n "sha256:${manifest_sha256}" > ${OUTPUT_DIR}/${REPO_DIR}/${image_name}/_manifests/tags/${image_tag}/current/link
    echo -n "sha256:${manifest_sha256}" > ${OUTPUT_DIR}/${REPO_DIR}/${image_name}/_manifests/revisions/sha256/${manifest_sha256}/link
    echo -n "sha256:${manifest_sha256}" > ${OUTPUT_DIR}/${REPO_DIR}/${image_name}/_manifests/tags/${image_tag}/index/sha256/${manifest_sha256}/link
    for layer in $(sed '/v1Compatibility/d' ${manifest} | grep -Eo '\b[a-f0-9]{64}\b' | sort -u); do
        mkdir -p ${OUTPUT_DIR}/${BLOB_DIR}/${layer:0:2}/${layer}
        mkdir -p ${OUTPUT_DIR}/${REPO_DIR}/${image_name}/_layers/sha256/${layer}
        ln -f ${BLOB_DIR}/${layer:0:2}/${layer}/data ${OUTPUT_DIR}/${BLOB_DIR}/${layer:0:2}/${layer}/data
        echo -n "sha256:${layer}" > ${OUTPUT_DIR}/${REPO_DIR}/${image_name}/_layers/sha256/${layer}/link
    done
done
```

## å»¶ä¼¸é˜…è¯»

- [æ·±å…¥æµ…å‡ºå®¹å™¨é•œåƒçš„ä¸€ç”Ÿ ğŸ¤”](https://blog.k8s.li/Exploring-container-image.html)
- [docker registry GC åŸç†åˆ†æ](https://blog.k8s.li/registry-gc.html)
- [docker registry è¿ç§»è‡³ harbor](https://blog.k8s.li/docker-registry-to-harbor.html)
- [overlay2 åœ¨æ‰“åŒ…å‘å¸ƒæµæ°´çº¿ä¸­çš„åº”ç”¨](https://blog.k8s.li/overlay2-on-package-pipline.html)
- [å¦‚ä½•ä½¿ç”¨ registry å­˜å‚¨çš„ç‰¹æ€§](https://blog.k8s.li/skopeo-to-registry.html)
- [ä»€ä¹ˆï¼Ÿå‘å¸ƒæµæ°´çº¿ä¸­é•œåƒâ€œåŒæ­¥â€é€Ÿåº¦åˆæå‡äº† 15 å€ ï¼](https://blog.k8s.li/select-registry-images.html)
